<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HashtagWebpage â€” Local Business Lead CRM</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #0f172a; }
    .stage-new            { border-left: 3px solid #6366f1; }
    .stage-site_generated { border-left: 3px solid #8b5cf6; }
    .stage-link_sent      { border-left: 3px solid #3b82f6; }
    .stage-following_up   { border-left: 3px solid #f59e0b; }
    .stage-customer       { border-left: 3px solid #10b981; }
    .stage-archived       { border-left: 3px solid #6b7280; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes slideIn { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast { animation: slideIn 0.3s ease-out; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_NAME = "HashtagWebpage";
const CF_DEFAULT_PROJECT = "hashtagwebpage";

// â”€â”€ Supabase config â€” set these once before deploying, anon key is safe to be public â”€â”€
// The anon key is a JWT with role:anon; real security comes from RLS policies in Supabase.
const SUPABASE_URL      = "";   // e.g. "https://xxxx.supabase.co"
const SUPABASE_ANON_KEY = "";   // e.g. "eyJhbGci..."

const MOCK_LEADS = [
  { id: "ChIJ1", name: "Mike's Plumbing Co", category: "Plumber", city: "Chicago, IL",
    phone: "(312) 555-0182", address: "4421 N Milwaukee Ave, Chicago, IL 60630",
    rating: 4.7, reviewCount: 38, hasWebsite: false, stage: "new",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 2,
    sentAt: null, followUpAt: null, convertedAt: null, previewUrl: null, email: null, notes: "" },
  { id: "ChIJ2", name: "Green Thumb Landscaping", category: "Landscaping", city: "Austin, TX",
    phone: "(512) 555-0293", address: "789 Oak Creek Blvd, Austin, TX 78701",
    rating: 4.9, reviewCount: 112, hasWebsite: false, stage: "site_generated",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 5,
    sentAt: null, followUpAt: null, convertedAt: null,
    previewUrl: "https://hashtagwebpage.pages.dev/green-thumb-landscaping-austin-tx",
    email: null, notes: "" },
  { id: "ChIJ3", name: "Clean Sweep Maids", category: "House Cleaning", city: "Denver, CO",
    phone: "(720) 555-0411", address: "220 Blake St, Denver, CO 80205",
    rating: 4.8, reviewCount: 76, hasWebsite: false, stage: "link_sent",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 7,
    sentAt: Date.now() - 86400000 * 2, followUpAt: Date.now() + 86400000 * 5,
    convertedAt: null, previewUrl: "https://hashtagwebpage.pages.dev/clean-sweep-maids-denver-co",
    email: "info@cleansweep.com", notes: "Owner seemed interested on the phone" },
  { id: "ChIJ4", name: "Rodriguez Electric", category: "Electrician", city: "Miami, FL",
    phone: "(305) 555-0574", address: "1100 Brickell Ave, Miami, FL 33131",
    rating: 4.6, reviewCount: 54, hasWebsite: false, stage: "following_up",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 14,
    sentAt: Date.now() - 86400000 * 7, followUpAt: Date.now() - 86400000 * 1,
    convertedAt: null, previewUrl: "https://hashtagwebpage.pages.dev/rodriguez-electric-miami-fl",
    email: "carlos@rodriguezelectric.com", notes: "Follow up call scheduled" },
  { id: "ChIJ5", name: "Apex Roofing Solutions", category: "Roofing", city: "Phoenix, AZ",
    phone: "(602) 555-0638", address: "3250 E Camelback Rd, Phoenix, AZ 85018",
    rating: 4.5, reviewCount: 29, hasWebsite: false, stage: "customer",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 21,
    sentAt: Date.now() - 86400000 * 16, followUpAt: null,
    convertedAt: Date.now() - 86400000 * 3,
    previewUrl: "https://hashtagwebpage.pages.dev/apex-roofing-solutions-phoenix-az",
    email: "steve@apexroofing.com", notes: "Paid $100 setup. Monthly hosting $5." },
  { id: "ChIJ6", name: "Fresh Cut Barbershop", category: "Barber", city: "Atlanta, GA",
    phone: "(404) 555-0712", address: "567 Peachtree St NE, Atlanta, GA 30308",
    rating: 4.8, reviewCount: 203, hasWebsite: false, stage: "new",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 1,
    sentAt: null, followUpAt: null, convertedAt: null, previewUrl: null, email: null, notes: "" },
  { id: "ChIJ7", name: "Elite Auto Detailing", category: "Car Wash", city: "Las Vegas, NV",
    phone: "(702) 555-0855", address: "8100 W Flamingo Rd, Las Vegas, NV 89147",
    rating: 4.3, reviewCount: 88, hasWebsite: false, stage: "archived",
    mapsUrl: "https://maps.google.com", foundAt: Date.now() - 86400000 * 30,
    sentAt: Date.now() - 86400000 * 23, followUpAt: Date.now() - 86400000 * 16,
    convertedAt: null, previewUrl: null, email: null, notes: "No response after 2 follow-ups" }
];

const CATEGORIES = [
  "Plumber","Electrician","Landscaping","House Cleaning","Roofing",
  "HVAC","Painter","Handyman","Carpenter","Pest Control",
  "Locksmith","Pool Service","Tree Service","Pressure Washing",
  "Auto Repair","Barber","Nail Salon","Pet Grooming","Flooring","Concrete"
];

const STAGES = {
  new:            { label: "New Lead",   bg: "bg-indigo-500/10",  text: "text-indigo-400",  border: "border-indigo-500/30" },
  site_generated: { label: "Site Ready", bg: "bg-purple-500/10",  text: "text-purple-400",  border: "border-purple-500/30" },
  link_sent:      { label: "Link Sent",  bg: "bg-blue-500/10",    text: "text-blue-400",    border: "border-blue-500/30" },
  following_up:   { label: "Follow-up",  bg: "bg-amber-500/10",   text: "text-amber-400",   border: "border-amber-500/30" },
  customer:       { label: "Customer âœ“", bg: "bg-emerald-500/10", text: "text-emerald-400", border: "border-emerald-500/30" },
  archived:       { label: "Archived",   bg: "bg-gray-500/10",    text: "text-gray-400",    border: "border-gray-500/30" }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const store = {
  getLeads:    () => { try { return JSON.parse(localStorage.getItem("hw_leads") || "null") || MOCK_LEADS; } catch { return MOCK_LEADS; } },
  saveLeads:   (l) => localStorage.setItem("hw_leads", JSON.stringify(l)),
  getSettings: () => {
    try {
      const saved = JSON.parse(localStorage.getItem("hw_settings") || "{}");
      // Hardcoded constants always win over localStorage for Supabase config
      if (SUPABASE_URL)      saved.supabaseUrl  = SUPABASE_URL;
      if (SUPABASE_ANON_KEY) saved.supabaseKey  = SUPABASE_ANON_KEY;
      return saved;
    } catch { return {}; }
  },
  saveSettings:(s) => localStorage.setItem("hw_settings", JSON.stringify(s))
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH HELPERS  (Supabase Auth, no extra SDK needed)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AUTH_KEY = "hwp_auth_session";

const auth = {
  getSession() {
    try {
      const s = JSON.parse(localStorage.getItem(AUTH_KEY) || "null");
      if (!s || !s.access_token) return null;
      // Treat as valid if expires_at is in the future (or not set)
      if (s.expires_at && Date.now() > s.expires_at) return null;
      return s;
    } catch { return null; }
  },
  setSession(data) {
    localStorage.setItem(AUTH_KEY, JSON.stringify({
      access_token:  data.access_token,
      refresh_token: data.refresh_token,
      expires_at:    Date.now() + ((data.expires_in || 3600) * 1000),
      user:          data.user,
    }));
  },
  clearSession() { localStorage.removeItem(AUTH_KEY); },
  async signIn(supabaseUrl, anonKey, email, password) {
    const res = await fetch(`${supabaseUrl.replace(/\/$/, "")}/auth/v1/token?grant_type=password`, {
      method: "POST",
      headers: { "apikey": anonKey, "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error_description || data.message || "Login failed");
    auth.setSession(data);
    return data;
  },
  async signOut(supabaseUrl, anonKey) {
    const session = auth.getSession();
    if (session) {
      await fetch(`${supabaseUrl.replace(/\/$/, "")}/auth/v1/logout`, {
        method: "POST",
        headers: { "apikey": anonKey, "Authorization": `Bearer ${session.access_token}` },
      }).catch(() => {});
    }
    auth.clearSession();
  },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUPABASE HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbFetch(supabaseUrl, key, path, method = "GET", body = null, extraHeaders = {}) {
  const headers = {
    "Content-Type": "application/json",
    "Accept": "application/json",
    ...extraHeaders
  };
  // Use authenticated JWT if available (for RLS), fall back to anon key
  const session = auth.getSession();
  const bearerToken = session?.access_token || key;
  if (key) { headers["apikey"] = key; }
  if (bearerToken) { headers["Authorization"] = `Bearer ${bearerToken}`; }
  const opts = { method, headers };
  if (body) opts.body = JSON.stringify(body);
  // Supabase cloud needs /rest/v1 prefix; local PostgREST serves at root /
  const isCloud = /supabase\.(co|in|com)/.test(supabaseUrl);
  const apiBase = isCloud ? "/rest/v1" : "";
  const res = await fetch(supabaseUrl.replace(/\/$/, "") + apiBase + path, opts);
  const text = await res.text();
  let data; try { data = JSON.parse(text); } catch { data = text; }
  if (!res.ok) throw new Error(typeof data === "object" ? (data.message || JSON.stringify(data)) : text);
  return data;
}

// Map camelCase lead fields â†’ Supabase snake_case columns
function leadToRow(lead) {
  return {
    id:           lead.id,
    name:         lead.name,
    category:     lead.category,
    city:         lead.city,
    phone:        lead.phone || null,
    address:      lead.address || "",
    email:        lead.email || null,
    rating:       lead.rating || 0,
    review_count: lead.reviewCount || 0,
    has_website:  lead.hasWebsite || false,
    stage:        lead.stage || "new",
    maps_url:     lead.mapsUrl || null,
    preview_url:  lead.previewUrl || null,
    deploy_url:   lead.deployUrl || null,
    notes:        lead.notes || "",
    sent_at:      lead.sentAt      ? new Date(lead.sentAt).toISOString()      : null,
    follow_up_at: lead.followUpAt  ? new Date(lead.followUpAt).toISOString()  : null,
    converted_at: lead.convertedAt ? new Date(lead.convertedAt).toISOString() : null,
    found_at:     lead.foundAt     ? new Date(lead.foundAt).toISOString()     : new Date().toISOString(),
  };
}

// Map Supabase row â†’ camelCase lead
function rowToLead(row) {
  return {
    id:          row.id,
    name:        row.name,
    category:    row.category || "",
    city:        row.city || "",
    phone:       row.phone || null,
    address:     row.address || "",
    email:       row.email || null,
    rating:      row.rating || 0,
    reviewCount: row.review_count || 0,
    hasWebsite:  row.has_website || false,
    stage:       row.stage || "new",
    mapsUrl:     row.maps_url || "#",
    previewUrl:  row.preview_url || null,
    deployUrl:   row.deploy_url || null,
    notes:       row.notes || "",
    sentAt:      row.sent_at      ? new Date(row.sent_at).getTime()      : null,
    followUpAt:  row.follow_up_at ? new Date(row.follow_up_at).getTime() : null,
    convertedAt: row.converted_at ? new Date(row.converted_at).getTime() : null,
    foundAt:     row.found_at     ? new Date(row.found_at).getTime()     : Date.now(),
  };
}

// Upsert a single lead to Supabase (merge-on-conflict by id)
async function dbSaveLead(lead, settings) {
  if (!settings.supabaseUrl) return;
  try {
    await sbFetch(
      settings.supabaseUrl, settings.supabaseKey,
      "/leads", "POST", leadToRow(lead),
      { "Prefer": "resolution=merge-duplicates" }
    );
  } catch(e) {
    console.warn("[Supabase] Save failed:", e.message);
  }
}

// Bulk upsert array of leads
async function dbSaveLeads(leads, settings) {
  if (!settings.supabaseUrl || !leads.length) return;
  try {
    await sbFetch(
      settings.supabaseUrl, settings.supabaseKey,
      "/leads", "POST", leads.map(leadToRow),
      { "Prefer": "resolution=merge-duplicates" }
    );
  } catch(e) {
    console.warn("[Supabase] Bulk save failed:", e.message);
  }
}

// Load ALL leads from Supabase
async function loadAllFromSupabase(settings) {
  if (!settings.supabaseUrl) return null;
  try {
    const rows = await sbFetch(
      settings.supabaseUrl, settings.supabaseKey,
      "/leads?order=found_at.desc&limit=1000", "GET"
    );
    return Array.isArray(rows) ? rows.map(rowToLead) : null;
  } catch(e) {
    console.warn("[Supabase] Load failed:", e.message);
    return null;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CATEGORY THEMES (shared between site generator + send preview)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORY_THEMES = {
  "Plumber":          { pri:"#1d4ed8", sec:"#1e3a8a", acc:"#60a5fa", icon:"ğŸ”§" },
  "Electrician":      { pri:"#7c3aed", sec:"#5b21b6", acc:"#a78bfa", icon:"âš¡" },
  "Landscaping":      { pri:"#15803d", sec:"#166534", acc:"#4ade80", icon:"ğŸŒ¿" },
  "House Cleaning":   { pri:"#0369a1", sec:"#075985", acc:"#38bdf8", icon:"âœ¨" },
  "Roofing":          { pri:"#b45309", sec:"#92400e", acc:"#fbbf24", icon:"ğŸ " },
  "HVAC":             { pri:"#b91c1c", sec:"#991b1b", acc:"#f87171", icon:"â„ï¸" },
  "Painter":          { pri:"#0f766e", sec:"#0d6b63", acc:"#2dd4bf", icon:"ğŸ¨" },
  "Handyman":         { pri:"#6d28d9", sec:"#5b21b6", acc:"#a78bfa", icon:"ğŸ”¨" },
  "Auto Repair":      { pri:"#374151", sec:"#1f2937", acc:"#9ca3af", icon:"ğŸš—" },
  "Barber":           { pri:"#9a3412", sec:"#7c2d12", acc:"#fb923c", icon:"âœ‚ï¸" },
  "Nail Salon":       { pri:"#9d174d", sec:"#831843", acc:"#f472b6", icon:"ğŸ’…" },
  "Pet Grooming":     { pri:"#0e7490", sec:"#0c6278", acc:"#22d3ee", icon:"ğŸ¾" },
  "Tree Service":     { pri:"#166534", sec:"#14532d", acc:"#4ade80", icon:"ğŸŒ³" },
  "Pest Control":     { pri:"#9a3412", sec:"#7c2d12", acc:"#fb923c", icon:"ğŸ›¡ï¸" },
  "Pool Service":     { pri:"#0369a1", sec:"#075985", acc:"#38bdf8", icon:"ğŸŠ" },
  "Pressure Washing": { pri:"#1d4ed8", sec:"#1e3a8a", acc:"#60a5fa", icon:"ğŸ’§" },
};
function getCategoryTheme(category) {
  return CATEGORY_THEMES[category] || { pri:"#4f46e5", sec:"#3730a3", acc:"#818cf8", icon:"â­" };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOOK MESSAGES â€” auto-generated per category, editable by user
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HOOK_MESSAGES = {
  "Plumber":          "Hi {name}! We noticed you don't have a website yet â€” so we built one for you, for free. Customers in {city} are searching for plumbers online right now and your competitors are getting those calls. Here's your live preview:",
  "Electrician":      "Hi {name}! We put together a free website for you. Homeowners in {city} search for electricians online first before calling â€” this gets you found and builds trust instantly. Take a look:",
  "Landscaping":      "Hi {name}! We built you a free website. Spring is coming and people in {city} are already searching for landscapers online. This puts you front and center when they do:",
  "House Cleaning":   "Hi {name}! We noticed you don't have a website. We built one for free â€” families in {city} search for cleaners online before calling anyone. Here's your live preview:",
  "Roofing":          "Hi {name}! We put together a free website for you. Storm season brings a wave of urgent searches for roofers in {city} â€” this puts you in front of homeowners when they need help most:",
  "HVAC":             "Hi {name}! We built you a free website. When AC breaks in {city}, people search online immediately for someone they can trust. This gets you found first:",
  "Painter":          "Hi {name}! We built you a free website. Homeowners in {city} look for painters online before asking neighbors â€” this is your chance to make a great first impression:",
  "Handyman":         "Hi {name}! We noticed you don't have a website. We built one for free â€” people in {city} search for handymen for everything from leaky faucets to deck repairs:",
  "Auto Repair":      "Hi {name}! We built you a free website. Car trouble is urgent â€” people in {city} search immediately for a shop they can trust. This puts you right there when they need you:",
  "Barber":           "Hi {name}! We put together a free website for you. Clients in {city} look for barbers online and book with whoever looks most professional. Here's yours:",
  "Nail Salon":       "Hi {name}! We built you a free website. People in {city} search for nail salons online before deciding where to go â€” this makes you the easy choice:",
  "Pet Grooming":     "Hi {name}! We put together a free website for you. Pet owners in {city} always research groomers online before trusting them with their dogs. Here's your preview:",
  "Tree Service":     "Hi {name}! We built you a free website. After any storm, homeowners in {city} search urgently for tree services â€” this gets you found first when it matters most:",
  "Pest Control":     "Hi {name}! We put together a free website for you. Pest problems feel urgent â€” people in {city} search for solutions immediately and go with whoever they find first:",
  "Pool Service":     "Hi {name}! We built you a free website. Pool owners in {city} search for reliable service before the season starts â€” this puts you at the top of their list:",
  "Pressure Washing": "Hi {name}! We built you a free website. Every spring, homeowners in {city} search for pressure washing services â€” this gets you in front of them at exactly the right time:",
};
function getHookMessage(lead) {
  const tpl = HOOK_MESSAGES[lead.category] ||
    "Hi {name}! We noticed you don't have a website, so we built one for you â€” for free. Take a look at your live preview:";
  return tpl.replace(/{name}/g, lead.name).replace(/{city}/g, lead.city);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SLUG + SITE GENERATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function slugify(name, city) {
  return (name + "-" + city)
    .toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}

// â”€â”€ GitHub API deploy (browser-native, no server needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deployViaGitHub(slug, html, settings) {
  const { githubOwner, githubRepo, githubToken, cfPagesDomain } = settings;
  const filePath = `webapp/sites/${slug}/index.html`;
  const apiUrl   = `https://api.github.com/repos/${githubOwner}/${githubRepo}/contents/${filePath}`;
  const headers  = {
    "Authorization": `Bearer ${githubToken}`,
    "Accept":        "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28",
    "Content-Type":  "application/json"
  };

  // Get existing file SHA (required if updating an existing file)
  let sha = null;
  try {
    const getRes = await fetch(apiUrl, { headers });
    if (getRes.ok) { const existing = await getRes.json(); sha = existing.sha; }
  } catch (_) {}

  // Base64-encode the HTML (btoa with UTF-8 support)
  const content = btoa(unescape(encodeURIComponent(html)));

  const putRes = await fetch(apiUrl, {
    method: "PUT",
    headers,
    body: JSON.stringify({
      message: `Deploy: ${slug}`,
      content,
      ...(sha ? { sha } : {})
    })
  });

  if (!putRes.ok) {
    const err = await putRes.json().catch(() => ({}));
    throw new Error(err.message || `GitHub API error ${putRes.status}`);
  }

  const domain = (cfPagesDomain || "hashtagwebpage.pages.dev").replace(/^https?:\/\//, "");
  return `https://${domain}/${slug}`;
}

function generateSiteHTML(lead, opts = {}) {
  const { name, category, phone = "Call us for a quote", address, city, rating, reviewCount: reviews } = lead;
  const { siteVisible = true, siteUrl = "" } = opts;

  // Category slug for image/logo lookup
  const catSlug  = category.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");
  const heroImg  = `/assets/categories/${catSlug}.jpg`;
  const logoPath = `/assets/logos/${catSlug}.png`;

  // Absolute URLs for Open Graph (WhatsApp / iMessage / Telegram link previews)
  const siteOrigin = siteUrl ? new URL(siteUrl).origin : "";
  const ogImage    = siteOrigin ? `${siteOrigin}/assets/categories/${catSlug}.jpg` : "";
  // Fallback chain: category logo â†’ yourlogo.png â†’ emoji sibling
  const defaultLogo = "/assets/logos/yourlogo.png";
  const logoFallbackHero = `if(this.src.indexOf('yourlogo')===-1){this.onerror=function(){this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='inline'};this.src='${defaultLogo}'}else{this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='inline'}`;
  const logoFallbackNav  = `if(this.src.indexOf('yourlogo')===-1){this.onerror=function(){this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='inline-flex'};this.src='${defaultLogo}'}else{this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='inline-flex'}`;
  const logoFallbackFoot = `if(this.src.indexOf('yourlogo')===-1){this.onerror=function(){this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='block'};this.src='${defaultLogo}'}else{this.onerror=null;this.style.display='none';this.nextElementSibling.style.display='block'}`;

  const themes = {
    "Plumber":          { pri:"#1d4ed8", sec:"#1e3a8a", acc:"#60a5fa", light:"#eff6ff", mid:"#bfdbfe", icon:"ğŸ”§", tagline:`Fast, Reliable Plumbing in ${city}`, svcs:["Pipe Repair & Replacement","Drain Cleaning","Water Heater Install","Emergency Plumbing","Leak Detection","Sewer Line Service"] },
    "Electrician":      { pri:"#7c3aed", sec:"#5b21b6", acc:"#a78bfa", light:"#f5f3ff", mid:"#ddd6fe", icon:"âš¡", tagline:`Licensed Electrician Serving ${city}`, svcs:["Panel Upgrades","Outlet & Switch Install","Wiring & Rewiring","Emergency Electrical","EV Charger Install","Smart Home Wiring"] },
    "Landscaping":      { pri:"#15803d", sec:"#166534", acc:"#4ade80", light:"#f0fdf4", mid:"#bbf7d0", icon:"ğŸŒ¿", tagline:`Beautiful Lawns & Gardens in ${city}`, svcs:["Lawn Mowing & Edging","Tree & Shrub Trimming","Garden Design","Seasonal Cleanup","Irrigation Systems","Mulching & Beds"] },
    "House Cleaning":   { pri:"#0369a1", sec:"#075985", acc:"#38bdf8", light:"#f0f9ff", mid:"#bae6fd", icon:"âœ¨", tagline:`Spotless Cleaning for ${city} Homes`, svcs:["Deep Cleaning","Regular Maintenance","Move-in / Move-out","Post-Construction","Office Cleaning","Eco-Friendly Products"] },
    "Roofing":          { pri:"#b45309", sec:"#92400e", acc:"#fbbf24", light:"#fffbeb", mid:"#fde68a", icon:"ğŸ ", tagline:`Expert Roofing Services in ${city}`, svcs:["Roof Repair","Full Replacement","Roof Inspection","Storm Damage","Gutter Installation","Flat Roof Systems"] },
    "HVAC":             { pri:"#b91c1c", sec:"#991b1b", acc:"#f87171", light:"#fef2f2", mid:"#fecaca", icon:"â„ï¸", tagline:`Comfort Year-Round in ${city}`, svcs:["AC Repair & Service","Heating Systems","New Installation","Maintenance Plans","Indoor Air Quality","Emergency Service"] },
    "Painter":          { pri:"#0f766e", sec:"#0d6b63", acc:"#2dd4bf", light:"#f0fdfa", mid:"#99f6e4", icon:"ğŸ¨", tagline:`Beautiful Paint Jobs in ${city}`, svcs:["Interior Painting","Exterior Painting","Cabinet Refinishing","Deck Staining","Wallpaper Removal","Color Consulting"] },
    "Handyman":         { pri:"#6d28d9", sec:"#5b21b6", acc:"#a78bfa", light:"#f5f3ff", mid:"#ddd6fe", icon:"ğŸ”¨", tagline:`Trusted Handyman in ${city}`, svcs:["General Repairs","Furniture Assembly","Door & Window Fixes","Drywall Patch","Tile & Grout","Odd Jobs"] },
    "Auto Repair":      { pri:"#374151", sec:"#1f2937", acc:"#9ca3af", light:"#f9fafb", mid:"#e5e7eb", icon:"ğŸš—", tagline:`Expert Auto Repair in ${city}`, svcs:["Oil & Filter Change","Brake Service","Engine Diagnostics","Tire Rotation","AC Recharge","Pre-Purchase Inspection"] },
    "Barber":           { pri:"#9a3412", sec:"#7c2d12", acc:"#fb923c", light:"#fff7ed", mid:"#fed7aa", icon:"âœ‚ï¸", tagline:`Sharp Cuts & Fresh Styles in ${city}`, svcs:["Haircuts","Beard Trim & Shape","Line-up & Fade","Hot Towel Shave","Kids Cuts","Senior Discounts"] },
    "Nail Salon":       { pri:"#9d174d", sec:"#831843", acc:"#f472b6", light:"#fdf2f8", mid:"#fbcfe8", icon:"ğŸ’…", tagline:`Beautiful Nails in ${city}`, svcs:["Manicure","Pedicure","Gel & Acrylic","Nail Art","Dip Powder","Lash Extensions"] },
    "Pet Grooming":     { pri:"#0e7490", sec:"#0c6278", acc:"#22d3ee", light:"#ecfeff", mid:"#a5f3fc", icon:"ğŸ¾", tagline:`Pamper Your Pet in ${city}`, svcs:["Bath & Brush","Haircut & Styling","Nail Trim","Ear Cleaning","Teeth Brushing","Full Groom Package"] },
    "Tree Service":     { pri:"#166534", sec:"#14532d", acc:"#4ade80", light:"#f0fdf4", mid:"#bbf7d0", icon:"ğŸŒ³", tagline:`Professional Tree Care in ${city}`, svcs:["Tree Trimming","Tree Removal","Stump Grinding","Emergency Service","Tree Health Assessment","Land Clearing"] },
    "Pest Control":     { pri:"#9a3412", sec:"#7c2d12", acc:"#fb923c", light:"#fff7ed", mid:"#fed7aa", icon:"ğŸ›¡ï¸", tagline:`Pest-Free Living in ${city}`, svcs:["Inspection","Extermination","Rodent Control","Preventive Treatment","Termite Treatment","Bed Bug Control"] },
    "Pool Service":     { pri:"#0369a1", sec:"#075985", acc:"#38bdf8", light:"#f0f9ff", mid:"#bae6fd", icon:"ğŸŠ", tagline:`Crystal Clear Pools in ${city}`, svcs:["Pool Cleaning","Chemical Balancing","Equipment Repair","Opening & Closing","Filter Service","Leak Detection"] },
    "Pressure Washing": { pri:"#1d4ed8", sec:"#1e3a8a", acc:"#60a5fa", light:"#eff6ff", mid:"#bfdbfe", icon:"ğŸ’§", tagline:`Sparkling Clean Surfaces in ${city}`, svcs:["House Washing","Driveway Cleaning","Deck & Patio","Roof Soft Wash","Fence Cleaning","Commercial Washing"] },
  };

  const t = themes[category] || { pri:"#4f46e5", sec:"#3730a3", acc:"#818cf8", light:"#eef2ff", mid:"#c7d2fe", icon:"â­", tagline:`Professional Services in ${city}`, svcs:["Expert Service","Licensed & Insured","Free Estimates","Quality Work","Satisfaction Guaranteed","5-Star Service"] };

  const hasRating = rating > 0;
  const starsFull = hasRating ? Math.round(rating) : 0;
  const starsStr  = "â˜…".repeat(starsFull) + "â˜†".repeat(5 - starsFull);

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>${name} | ${category} in ${city}</title>
<meta name="description" content="${name} â€” trusted ${category.toLowerCase()} serving ${city}. Call today for a free estimate. Licensed, insured &amp; highly rated."/>
${!siteVisible ? '<meta name="robots" content="noindex,nofollow"/>' : ""}
${siteUrl ? `<!-- Open Graph: WhatsApp / iMessage / Telegram / Slack previews -->
<meta property="og:type" content="website"/>
<meta property="og:url" content="${siteUrl}"/>
<meta property="og:site_name" content="${name}"/>
<meta property="og:title" content="${name} | ${category} in ${city}"/>
<meta property="og:description" content="${name} â€” trusted ${category.toLowerCase()} serving ${city}. Free estimates. Licensed &amp; insured."/>
<meta property="og:image" content="${ogImage}"/>
<meta property="og:image:width" content="1200"/>
<meta property="og:image:height" content="630"/>
<meta property="og:image:alt" content="${name} â€” ${category} in ${city}"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="${name} | ${category} in ${city}"/>
<meta name="twitter:description" content="${name} â€” trusted ${category.toLowerCase()} serving ${city}."/>
<meta name="twitter:image" content="${ogImage}"/>` : ""}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--pri:${t.pri};--sec:${t.sec};--acc:${t.acc};--light:${t.light};--mid:${t.mid}}
body{font-family:'Inter',system-ui,sans-serif;background:#fff;color:#111827;line-height:1.6;overflow-x:hidden}
/* NAV */
.nav{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(14px);border-bottom:1px solid rgba(0,0,0,.07);padding:13px 24px;display:flex;align-items:center;justify-content:space-between}
.nav-brand{font-size:1rem;font-weight:800;color:var(--pri);letter-spacing:-.02em}
.nav-cta{background:var(--pri);color:#fff;padding:9px 20px;border-radius:100px;font-size:.875rem;font-weight:700;text-decoration:none;transition:opacity .15s,transform .15s}
.nav-cta:hover{opacity:.88;transform:translateY(-1px)}
/* HERO */
.hero{background:linear-gradient(135deg,${t.pri}cc 0%,${t.sec} 100%),url('${heroImg}') center/cover no-repeat;background-size:auto,cover;background-position:center;padding:88px 24px 100px;text-align:center;color:#fff;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 20% 20%,rgba(255,255,255,.14) 0%,transparent 60%),radial-gradient(ellipse 50% 50% at 80% 85%,rgba(0,0,0,.2) 0%,transparent 55%);pointer-events:none}
.hero-inner{position:relative;z-index:1;max-width:720px;margin:0 auto}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);padding:6px 16px;border-radius:100px;font-size:.78rem;font-weight:700;margin-bottom:20px;letter-spacing:.06em;text-transform:uppercase}
.hero h1{font-size:clamp(2rem,6vw,3.8rem);font-weight:900;line-height:1.07;letter-spacing:-.04em;margin-bottom:14px;text-shadow:0 2px 20px rgba(0,0,0,.15)}
.hero-sub{font-size:1.1rem;opacity:.88;margin-bottom:26px;font-weight:400}
.rating-row{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.3);padding:8px 20px;border-radius:100px;font-size:.93rem;margin-bottom:28px}
.stars{color:#fbbf24;letter-spacing:2px;font-size:1.1rem}
.hero-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.btn-call{background:#fff;color:var(--pri);padding:14px 32px;border-radius:100px;font-size:1rem;font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 30px rgba(0,0,0,.22);transition:transform .15s,box-shadow .15s}
.btn-call:hover{transform:translateY(-2px);box-shadow:0 14px 40px rgba(0,0,0,.3)}
.btn-quote{background:transparent;color:#fff;padding:14px 32px;border-radius:100px;font-size:1rem;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:8px;border:2px solid rgba(255,255,255,.55);transition:background .15s,border-color .15s}
.btn-quote:hover{background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.85)}
/* LOGO */
.biz-logo{height:64px;width:auto;max-width:200px;object-fit:contain;filter:brightness(0)invert(1);margin-bottom:16px;display:block;margin-left:auto;margin-right:auto}
.nav-logo{height:36px;width:auto;max-width:140px;object-fit:contain;vertical-align:middle}
.foot-logo{height:36px;width:auto;max-width:120px;object-fit:contain;filter:brightness(0)invert(.7);margin-bottom:8px}
/* TRUST BAR */
.trust-bar{background:#fff;border-bottom:1px solid #f0f0f0;padding:16px 24px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.trust-item{display:flex;align-items:center;gap:7px;font-size:.8rem;font-weight:600;color:#374151;background:var(--light);border:1px solid var(--mid);padding:5px 14px;border-radius:100px}
/* SECTIONS */
.section{padding:70px 24px;max-width:1100px;margin:0 auto}
.section-label{display:inline-block;background:var(--light);color:var(--pri);padding:4px 14px;border-radius:100px;font-size:.73rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-bottom:14px;border:1px solid var(--mid)}
.section h2{font-size:clamp(1.6rem,4vw,2.3rem);font-weight:800;color:#111827;letter-spacing:-.035em;margin-bottom:10px;line-height:1.18}
.section h2 .hl{color:var(--pri)}
.section-sub{font-size:.98rem;color:#6b7280;max-width:560px;line-height:1.65}
/* SERVICES */
.services-bg{background:#f8fafc}
.services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:18px;margin-top:38px}
.service-card{background:#fff;border:1.5px solid var(--mid);border-radius:18px;padding:26px 20px;transition:transform .2s,box-shadow .2s,border-color .2s;position:relative;overflow:hidden}
.service-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:18px 18px 0 0}
.service-card:hover{transform:translateY(-5px);box-shadow:0 16px 40px rgba(0,0,0,.1);border-color:var(--acc)}
.service-icon{font-size:1.9rem;margin-bottom:13px}
.service-card h3{font-weight:700;color:#111827;font-size:.95rem;line-height:1.3}
.service-card p{font-size:.82rem;color:#6b7280;margin-top:5px;line-height:1.5}
/* WHY */
.why-bg{background:var(--light)}
.why-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:38px}
.why-card{background:#fff;border-radius:16px;padding:24px;display:flex;gap:16px;align-items:flex-start;border:1.5px solid var(--mid);transition:box-shadow .2s}
.why-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.07)}
.why-num{width:42px;height:42px;border-radius:12px;flex-shrink:0;background:linear-gradient(135deg,var(--pri),var(--acc));color:#fff;font-size:.82rem;font-weight:900;display:flex;align-items:center;justify-content:center}
.why-card h4{font-weight:700;color:#111827;font-size:.95rem;margin-bottom:4px}
.why-card p{font-size:.82rem;color:#6b7280;line-height:1.5}
/* RATING */
.rating-section{background:#fff;padding:70px 24px;text-align:center}
.rating-big{font-size:4.5rem;font-weight:900;color:var(--pri);letter-spacing:-.05em;line-height:1}
.stars-big{font-size:2rem;color:#fbbf24;letter-spacing:4px;margin:10px 0}
.review-count{font-size:.95rem;color:#6b7280}
.google-badge{display:inline-flex;align-items:center;gap:8px;margin-top:20px;background:#f8fafc;border:1.5px solid #e2e8f0;padding:10px 20px;border-radius:100px;font-size:.83rem;font-weight:600;color:#374151}
/* INFO BAR */
.info-bar{background:var(--light);border-top:1px solid var(--mid);border-bottom:1px solid var(--mid);padding:18px 24px;text-align:center}
.info-items{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}
.info-item{font-size:.88rem;color:#374151;display:flex;align-items:center;gap:7px}
.info-item strong{color:var(--pri);font-weight:700}
/* CONTACT */
.contact-section{background:linear-gradient(135deg,var(--pri) 0%,var(--sec) 100%);padding:80px 24px;text-align:center;position:relative;overflow:hidden}
.contact-section::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 60% at 80% 20%,rgba(255,255,255,.11) 0%,transparent 60%);pointer-events:none}
.contact-inner{position:relative;z-index:1;max-width:540px;margin:0 auto}
.contact-section h2{font-size:clamp(1.6rem,4vw,2.2rem);font-weight:800;color:#fff;margin-bottom:10px;letter-spacing:-.03em}
.contact-section p{color:rgba(255,255,255,.82);margin-bottom:32px}
.form-card{background:#fff;border-radius:20px;padding:30px;text-align:left;box-shadow:0 20px 60px rgba(0,0,0,.22)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:.8rem;font-weight:600;color:#374151;margin-bottom:5px}
.form-input{width:100%;padding:11px 15px;border-radius:10px;border:1.5px solid #e2e8f0;background:#f8fafc;color:#111827;font-size:.93rem;font-family:inherit;transition:border-color .2s,background .2s}
.form-input:focus{outline:none;border-color:var(--pri);background:#fff}
.form-input::placeholder{color:#9ca3af}
textarea.form-input{height:96px;resize:vertical}
.form-submit{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;background:linear-gradient(135deg,var(--pri),var(--acc));color:#fff;font-size:1rem;font-weight:700;font-family:inherit;transition:opacity .2s,transform .15s;box-shadow:0 6px 20px rgba(0,0,0,.16)}
.form-submit:hover{opacity:.9;transform:translateY(-1px)}
.form-submit:disabled{opacity:.65;cursor:not-allowed}
#form-status{margin-top:12px;font-size:.86rem;text-align:center}
/* FOOTER */
footer{background:#0f172a;color:#64748b;text-align:center;padding:26px 24px;font-size:.84rem}
footer a{color:#94a3b8;text-decoration:none;transition:color .15s}
footer a:hover{color:#fff}
.footer-brand{font-size:.92rem;font-weight:800;color:#e2e8f0;margin-bottom:6px}
/* PREVIEW BANNER */
${!siteVisible ? `.preview-banner{position:fixed;bottom:0;left:0;right:0;z-index:9999;background:#f59e0b;color:#1a1a2e;text-align:center;padding:10px 20px;font-size:.84rem;font-weight:600;box-shadow:0 -4px 20px rgba(0,0,0,.15)}` : ""}
/* RESPONSIVE */
@media(max-width:640px){
  .hero{padding:70px 20px 80px}
  .services-grid,.why-grid{grid-template-columns:1fr 1fr}
  .trust-bar{justify-content:flex-start}
  .hero-btns,.info-items{flex-direction:column;align-items:center}
}
@media(max-width:400px){.services-grid,.why-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-brand">
    <img class="nav-logo" src="${logoPath}" alt="${name} logo" onerror="${logoFallbackNav}">
    <span style="display:none;align-items:center;gap:6px">${t.icon} ${name}</span>
    <span class="nav-name" style="margin-left:8px;font-weight:800;font-size:1rem;color:var(--pri)">${name}</span>
  </div>
  <a href="tel:${phone.replace(/\D/g,"")}" class="nav-cta">ğŸ“ Call Now</a>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="hero-inner">
    <img class="biz-logo" src="${logoPath}" alt="${name} logo" onerror="${logoFallbackHero}">
    <span style="display:none;font-size:2.8rem;margin-bottom:16px">${t.icon}</span>
    <div class="hero-badge">${category} Services</div>
    <h1>${name}</h1>
    <p class="hero-sub">${t.tagline}</p>
    ${hasRating ? `<div style="margin-bottom:26px"><div class="rating-row"><span class="stars">${starsStr}</span><strong>${rating.toFixed(1)}</strong><span style="opacity:.78">&nbsp;Â·&nbsp;${reviews} Google Reviews</span></div></div>` : ""}
    <div class="hero-btns">
      <a href="tel:${phone.replace(/\D/g,"")}" class="btn-call">ğŸ“ ${phone}</a>
      <a href="#contact" class="btn-quote">Get Free Quote â†’</a>
    </div>
  </div>
</section>

<!-- TRUST BAR -->
<div class="trust-bar">
  <div class="trust-item">âœ… Licensed & Insured</div>
  <div class="trust-item">ğŸ† ${hasRating ? rating.toFixed(1)+"â˜… Rated" : "Highly Rated"}</div>
  <div class="trust-item">ğŸ“ Serving ${city}</div>
  <div class="trust-item">ğŸ’¬ Free Estimates</div>
  <div class="trust-item">âš¡ Fast Response</div>
</div>

<!-- SERVICES -->
<div class="services-bg">
  <div class="section">
    <div class="section-label">What We Do</div>
    <h2>Our <span class="hl">Services</span></h2>
    <p class="section-sub">Comprehensive ${category.toLowerCase()} services for homeowners and businesses throughout ${city}.</p>
    <div class="services-grid">
      ${t.svcs.map(s => `<div class="service-card"><div class="service-icon">${t.icon}</div><h3>${s}</h3><p>Professional, reliable service with guaranteed satisfaction.</p></div>`).join("\n      ")}
    </div>
  </div>
</div>

<!-- WHY CHOOSE US -->
<div class="why-bg">
  <div class="section">
    <div class="section-label">Why Us</div>
    <h2>Why ${city} Trusts <span class="hl">${name}</span></h2>
    <p class="section-sub">We're more than just a service â€” we're your neighbor, your go-to pro, your peace of mind.</p>
    <div class="why-grid">
      <div class="why-card"><div class="why-num">01</div><div><h4>Fast Response</h4><p>Same-day and emergency service available when you need us most.</p></div></div>
      <div class="why-card"><div class="why-num">02</div><div><h4>Licensed & Insured</h4><p>Fully licensed, bonded, and insured for your complete peace of mind.</p></div></div>
      <div class="why-card"><div class="why-num">03</div><div><h4>Satisfaction Guaranteed</h4><p>We stand behind every job â€” 100%. Your satisfaction is our standard.</p></div></div>
      <div class="why-card"><div class="why-num">04</div><div><h4>Transparent Pricing</h4><p>Free estimates with absolutely no hidden fees or surprise charges.</p></div></div>
    </div>
  </div>
</div>

<!-- INFO BAR -->
<div class="info-bar">
  <div class="info-items">
    <div class="info-item">ğŸ“ <strong>Serving ${city}</strong></div>
    <div class="info-item">ğŸ“ <strong><a href="tel:${phone.replace(/\D/g,"")}" style="color:var(--pri);text-decoration:none">${phone}</a></strong></div>
    <div class="info-item">ğŸ—ºï¸ ${address}</div>
  </div>
</div>

${hasRating ? `<!-- RATING -->
<div class="rating-section">
  <div class="section-label" style="margin-bottom:20px">Customer Reviews</div>
  <div class="rating-big">${rating.toFixed(1)}</div>
  <div class="stars-big">${starsStr}</div>
  <div class="review-count">${reviews} verified reviews on Google</div>
  <div>
    <div class="google-badge">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Verified Google Reviews
    </div>
  </div>
</div>` : ""}

<!-- CONTACT -->
<div id="contact" class="contact-section">
  <div class="contact-inner">
    <h2>Get a Free Quote</h2>
    <p>Fill in your details and we'll get back to you within 24 hours â€” usually much faster.</p>
    <div class="form-card">
      <form id="contact-form">
        <input type="hidden" name="business_name" value="${name}"/>
        <div class="form-group"><label class="form-label">Your Name *</label><input class="form-input" type="text" name="name" placeholder="Jane Smith" required/></div>
        <div class="form-group"><label class="form-label">Phone Number *</label><input class="form-input" type="tel" name="phone" placeholder="(555) 000-0000" required/></div>
        <div class="form-group"><label class="form-label">Email Address</label><input class="form-input" type="email" name="email" placeholder="you@email.com"/></div>
        <div class="form-group"><label class="form-label">How can we help?</label><textarea class="form-input" name="message" placeholder="Tell us about your project..."></textarea></div>
        <button type="submit" class="form-submit">Send My Request â†’</button>
        <div id="form-status"></div>
      </form>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <img class="foot-logo" src="${logoPath}" alt="${name} logo" onerror="${logoFallbackFoot}">
  <div class="footer-brand" style="display:none">${t.icon} ${name}</div>
  <div class="footer-brand">${name}</div>
  <p>${address} &nbsp;Â·&nbsp; ${city}</p>
  <p style="margin-top:4px"><a href="tel:${phone.replace(/\D/g,"")}">${phone}</a></p>
  <p style="margin-top:12px;opacity:.55">Â© ${new Date().getFullYear()} ${name} &nbsp;Â·&nbsp; Website by <a href="https://hashtagwebpage.com" target="_blank">HashtagWebpage</a></p>
</footer>

${!siteVisible ? '<div class="preview-banner">ğŸ”’ Preview Mode â€” This site is not yet public. <a href="https://hashtagwebpage.com" style="color:#1a1a2e;text-decoration:underline">Contact HashtagWebpage</a> to publish it.</div>' : ""}

<script>
(function(){
  var form=document.getElementById("contact-form"),status=document.getElementById("form-status");
  form.addEventListener("submit",function(e){
    e.preventDefault();
    var btn=form.querySelector(".form-submit");
    btn.disabled=true;btn.textContent="Sending...";
    var data={};new FormData(form).forEach(function(v,k){data[k]=v;});
    fetch("https://formspree.io/f/YOUR_FORM_ID",{method:"POST",headers:{"Content-Type":"application/json","Accept":"application/json"},body:JSON.stringify(data)})
    .then(function(r){
      if(r.ok){status.innerHTML='<p style="color:#16a34a;font-weight:600;margin-top:12px">âœ… Thanks! We\'ll be in touch soon.</p>';form.reset();}
      else{status.innerHTML='<p style="color:#dc2626;margin-top:12px">âŒ Something went wrong. Please call us directly.</p>';}
    }).catch(function(){status.innerHTML='<p style="color:#dc2626;margin-top:12px">âŒ Could not send. Please call us directly.</p>';})
    .finally(function(){btn.disabled=false;btn.textContent="Send My Request â†’";});
  });
  document.querySelectorAll('a[href^="#"]').forEach(function(a){
    a.addEventListener("click",function(e){var el=document.querySelector(a.getAttribute("href"));if(el){e.preventDefault();el.scrollIntoView({behavior:"smooth"});}});
  });
})();
<\/script>
</body>
</html>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Badge({ stage }) {
  const s = STAGES[stage] || STAGES.new;
  return <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${s.bg} ${s.text} border ${s.border}`}>{s.label}</span>;
}

function StarRating({ rating }) {
  return <span className="flex items-center gap-1 text-amber-400 text-sm">â˜… <span className="text-slate-300">{rating.toFixed(1)}</span></span>;
}

function StatCard({ icon, label, value, sub, color }) {
  return (
    <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5 flex items-start gap-4">
      <div className={`text-2xl w-10 h-10 flex items-center justify-center rounded-lg ${color} flex-shrink-0`}>{icon}</div>
      <div>
        <div className="text-2xl font-bold text-white">{value}</div>
        <div className="text-sm text-slate-400">{label}</div>
        {sub && <div className="text-xs text-slate-500 mt-0.5">{sub}</div>}
      </div>
    </div>
  );
}

function ToastContainer({ toasts }) {
  return (
    <div className="fixed bottom-5 right-5 z-[100] flex flex-col gap-2 pointer-events-none">
      {toasts.map(t => (
        <div key={t.id} className={`toast pointer-events-auto px-4 py-3 rounded-xl shadow-2xl text-sm font-medium max-w-xs
          ${t.type === "error"
            ? "bg-red-950 border border-red-500/40 text-red-300"
            : "bg-slate-800 border border-emerald-500/40 text-emerald-300"}`}>
          {t.msg}
        </div>
      ))}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LEAD CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LeadCard({ lead, onAction, onSelect, onSendPreview, deploying }) {
  const daysAgo = Math.floor((Date.now() - lead.foundAt) / 86400000);
  const followUpDue = lead.followUpAt && lead.followUpAt < Date.now();
  const isDeploying = deploying && deploying.has(lead.id);

  return (
    <div
      className={`bg-slate-800/80 border border-slate-700/50 rounded-xl p-4 cursor-pointer hover:border-slate-500/70 transition-all fade-in stage-${lead.stage}`}
      onClick={() => onSelect(lead)}
    >
      <div className="flex justify-between items-start mb-2">
        <div className="flex-1 min-w-0 pr-2">
          <div className="font-semibold text-white text-sm leading-tight truncate">{lead.name}</div>
          <div className="text-xs text-slate-400 mt-0.5">{lead.category} Â· {lead.city}</div>
        </div>
        <Badge stage={lead.stage} />
      </div>

      {lead.phone && <div className="text-xs text-slate-400 mt-2 flex items-center gap-1.5"><span>ğŸ“</span>{lead.phone}</div>}
      <div className="text-xs text-slate-500 mt-1 flex items-center gap-1.5 truncate">
        <span>ğŸ“</span><span className="truncate">{lead.address}</span>
      </div>

      <div className="flex items-center justify-between mt-3">
        <div className="flex items-center gap-3">
          {lead.rating > 0 && <StarRating rating={lead.rating} />}
          {lead.reviewCount > 0 && <span className="text-xs text-slate-500">({lead.reviewCount})</span>}
        </div>
        <span className="text-xs text-slate-600">{daysAgo === 0 ? "Today" : `${daysAgo}d ago`}</span>
      </div>

      {followUpDue && (
        <div className="mt-2 text-xs text-amber-400 flex items-center gap-1">
          <span className="pulse-dot">âš¡</span> Follow-up overdue
        </div>
      )}

      <div className="flex gap-2 mt-3" onClick={e => e.stopPropagation()}>
        {lead.stage === "new" && (
          <button onClick={() => onAction(lead.id, "generate")} disabled={isDeploying}
            className="flex-1 text-xs bg-purple-600 hover:bg-purple-500 disabled:opacity-60 text-white px-3 py-1.5 rounded-lg transition-colors">
            {isDeploying ? <span className="inline-block spin">â³</span> : "ğŸŒ Generate Site"}
          </button>
        )}
        {lead.stage === "site_generated" && (
          <button onClick={() => onSendPreview(lead)}
            className="flex-1 text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors">
            ğŸ“¤ Send Preview
          </button>
        )}
        {(lead.stage === "link_sent" || lead.stage === "following_up") && (
          <button onClick={() => onAction(lead.id, "convert")}
            className="flex-1 text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg transition-colors">
            âœ… Convert
          </button>
        )}
        {!["archived","customer"].includes(lead.stage) && (
          <button onClick={() => onAction(lead.id, "archive")}
            className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded-lg transition-colors">
            Archive
          </button>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LEAD DETAIL MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LeadModal({ lead, onClose, onAction, onUpdate, onPreview, onSendPreview, deploying }) {
  const [notes, setNotes] = React.useState(lead.notes || "");
  const [email, setEmail] = React.useState(lead.email || "");
  const isDeploying = deploying && deploying.has(lead.id);
  const save = () => onUpdate(lead.id, { notes, email });

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl fade-in" onClick={e => e.stopPropagation()}>
        <div className="flex items-start justify-between p-5 border-b border-slate-700">
          <div>
            <h2 className="text-lg font-bold text-white">{lead.name}</h2>
            <div className="text-sm text-slate-400">{lead.category} Â· {lead.city}</div>
          </div>
          <div className="flex items-center gap-2">
            <Badge stage={lead.stage} />
            <button onClick={onClose} className="text-slate-400 hover:text-white text-xl ml-2">Ã—</button>
          </div>
        </div>

        <div className="p-5 space-y-4 overflow-y-auto max-h-[60vh]">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-slate-800 rounded-lg p-3">
              <div className="text-xs text-slate-500 mb-1">Phone</div>
              <div className="text-sm text-white">{lead.phone || "Not available"}</div>
            </div>
            <div className="bg-slate-800 rounded-lg p-3">
              <div className="text-xs text-slate-500 mb-1">Rating</div>
              <div className="text-sm text-white flex items-center gap-1">
                {lead.rating > 0 ? <><StarRating rating={lead.rating} /><span className="text-slate-400">({lead.reviewCount})</span></> : "No reviews"}
              </div>
            </div>
          </div>

          <div className="bg-slate-800 rounded-lg p-3">
            <div className="text-xs text-slate-500 mb-1">Address</div>
            <div className="text-sm text-white">{lead.address}</div>
            <a href={lead.mapsUrl} target="_blank" rel="noopener" className="text-xs text-blue-400 hover:underline mt-1 inline-block">View on Google Maps â†’</a>
          </div>

          <div>
            <label className="text-xs text-slate-400 mb-1 block">Business Email (for sending preview)</label>
            <input value={email} onChange={e => setEmail(e.target.value)} placeholder="owner@business.com"
              className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500" />
          </div>

          {lead.previewUrl && (
            <div className="bg-slate-800 rounded-lg p-3">
              <div className="text-xs text-slate-500 mb-1">Live URL</div>
              <a href={lead.previewUrl} target="_blank" rel="noopener" className="text-sm text-blue-400 hover:underline break-all">{lead.previewUrl}</a>
              <button onClick={() => { save(); onPreview(lead.id); }}
                className="mt-2 block text-xs text-purple-400 hover:underline">ğŸ” Preview HTML â†’</button>
            </div>
          )}

          <div>
            <label className="text-xs text-slate-400 mb-1 block">Notes</label>
            <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={3}
              placeholder="Add notes about this lead..."
              className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 resize-none" />
          </div>

          <div className="bg-slate-800 rounded-lg p-3">
            <div className="text-xs text-slate-500 mb-2">Timeline</div>
            <div className="space-y-1.5 text-xs">
              <div className="flex items-center gap-2 text-slate-400"><span className="text-indigo-400">â—</span>Found: {new Date(lead.foundAt).toLocaleDateString()}</div>
              {lead.sentAt && <div className="flex items-center gap-2 text-slate-400"><span className="text-blue-400">â—</span>Link sent: {new Date(lead.sentAt).toLocaleDateString()}</div>}
              {lead.followUpAt && (
                <div className="flex items-center gap-2 text-slate-400">
                  <span className={lead.followUpAt < Date.now() ? "text-amber-400" : "text-slate-500"}>â—</span>
                  Follow-up: {new Date(lead.followUpAt).toLocaleDateString()}
                  {lead.followUpAt < Date.now() && <span className="text-amber-400">(overdue)</span>}
                </div>
              )}
              {lead.convertedAt && <div className="flex items-center gap-2 text-slate-400"><span className="text-emerald-400">â—</span>Converted: {new Date(lead.convertedAt).toLocaleDateString()}</div>}
            </div>
          </div>
        </div>

        <div className="p-4 border-t border-slate-700 flex gap-2 flex-wrap">
          <button onClick={save} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg transition-colors">Save</button>
          {lead.stage !== "new" && (
            <button onClick={() => { onAction(lead.id, "reset"); onClose(); }}
              title="Reset back to New so you can regenerate the site"
              className="px-3 py-2 bg-slate-700 hover:bg-amber-600/80 text-slate-400 hover:text-white text-sm rounded-lg transition-colors" >
              â†© Reset
            </button>
          )}
          {lead.stage === "new" && (
            <button disabled={isDeploying} onClick={() => { save(); onAction(lead.id, "generate"); onClose(); }}
              className="flex-1 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-60 text-white text-sm rounded-lg transition-colors">
              {isDeploying ? "â³ Deploying..." : "ğŸŒ Generate & Deploy"}
            </button>
          )}
          {lead.stage === "site_generated" && (
            <>
              <button onClick={() => { save(); onPreview(lead.id); }}
                className="py-2 px-3 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg transition-colors">ğŸ” Preview</button>
              <button onClick={() => { save(); onClose(); onSendPreview(lead); }}
                className="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-lg transition-colors">ğŸ“¤ Send Preview</button>
            </>
          )}
          {(lead.stage === "link_sent" || lead.stage === "following_up") && (
            <button onClick={() => { save(); onAction(lead.id, "convert"); onClose(); }}
              className="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm rounded-lg transition-colors">âœ… Mark as Customer</button>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SEND PREVIEW MODAL â€” thumbnail card + hook message + email send
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SendPreviewModal({ lead, settings, onClose, onSent }) {
  const theme = getCategoryTheme(lead.category);
  const [email, setEmail]       = React.useState(lead.email || "");
  const [phone, setPhone]       = React.useState(lead.phone || "");
  const [hook, setHook]         = React.useState(getHookMessage(lead));
  const [shareTab, setShareTab] = React.useState("email"); // "email" | "sms"
  const [sending, setSending]   = React.useState(false);
  const [sent, setSent]         = React.useState(false);
  const [copied, setCopied]     = React.useState(false);
  const previewUrl = lead.previewUrl || "";
  const hasRating  = lead.rating > 0;
  const starsStr   = hasRating ? "â˜…".repeat(Math.round(lead.rating)) + "â˜†".repeat(5 - Math.round(lead.rating)) : "";

  const copyLink = () => {
    navigator.clipboard.writeText(previewUrl).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
  };

  // Short SMS message (fits in 1-2 texts, ~160 chars each)
  const smsMsg = `Hi! We built ${lead.name} a free website â€” check it out: ${previewUrl}\n\nKeep it live for $49/mo or own it for $297. Reply to this to get started! â€“ HashtagWebpage`;
  // WhatsApp can be longer â€” use the full hook
  const waMsg  = `${hook}\n\n${previewUrl}\n\nğŸ’° Keep it live for $49/mo Â· Own it forever for $297\nJust reply or call us to get started!`;

  const openSMS       = () => window.open(`sms:?body=${encodeURIComponent(smsMsg)}`);
  const openWhatsApp  = () => window.open(`https://wa.me/?text=${encodeURIComponent(waMsg)}`);
  const copySMSMsg    = () => navigator.clipboard.writeText(smsMsg).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });

  const sendEmail = async () => {
    if (!email) return;
    setSending(true);
    try {
      const edgeFnUrl = (settings.supabaseUrl || "").replace(/\/$/, "") + "/functions/v1/send-email";
      const res = await fetch(edgeFnUrl, {
        method: "POST",
        headers: {
          "Content-Type":  "application/json",
          "Authorization": `Bearer ${settings.supabaseKey || ""}`
        },
        body: JSON.stringify({
          to: email,
          businessName: lead.name,
          previewUrl,
          hookMessage: hook,
          category:    lead.category,
          city:        lead.city,
          phone:       lead.phone || "",
          rating:      lead.rating || 0,
          reviews:     lead.reviewCount || 0,
          themePri:    theme.pri,
          themeSec:    theme.sec,
          themeAcc:    theme.acc,
          themeIcon:   theme.icon,
        })
      });
      const data = await res.json();
      if (data.ok || data.id) { setSent(true); onSent(lead.id, email); }
      else throw new Error(data.message || data.error || "Send failed");
    } catch (e) {
      alert("Send failed: " + e.message);
    } finally { setSending(false); }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/75 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl fade-in flex flex-col max-h-[92vh]" onClick={e => e.stopPropagation()}>

        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700 flex-shrink-0">
          <div>
            <h2 className="text-lg font-bold text-white">ğŸ“¤ Send Preview</h2>
            <p className="text-xs text-slate-400 mt-0.5">{lead.name} Â· {lead.category} Â· {lead.city}</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">Ã—</button>
        </div>

        <div className="overflow-y-auto flex-1 p-6 space-y-5">

          {/* THUMBNAIL CARD */}
          <div>
            <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Website Preview</div>
            <div className="rounded-xl overflow-hidden border border-slate-700 shadow-xl">
              {/* Browser chrome mock */}
              <div className="bg-slate-800 px-4 py-2.5 flex items-center gap-2 border-b border-slate-700">
                <div className="flex gap-1.5">
                  <div className="w-3 h-3 rounded-full bg-red-500/70" />
                  <div className="w-3 h-3 rounded-full bg-yellow-500/70" />
                  <div className="w-3 h-3 rounded-full bg-green-500/70" />
                </div>
                <div className="flex-1 bg-slate-700 rounded-md px-3 py-1 text-xs text-slate-400 font-mono truncate ml-2">
                  {previewUrl || "https://hashtagwebpage.com/your-business"}
                </div>
              </div>
              {/* Hero thumbnail */}
              <div style={{ background: `linear-gradient(135deg, ${theme.pri} 0%, ${theme.sec} 100%)` }}
                className="px-8 py-10 text-white text-center relative overflow-hidden">
                {/* Radial glow */}
                <div style={{ position:"absolute", inset:0, background:"radial-gradient(ellipse 70% 60% at 25% 25%, rgba(255,255,255,.13) 0%, transparent 60%)", pointerEvents:"none" }} />
                <div className="relative z-10">
                  <div style={{ display:"inline-flex", alignItems:"center", gap:8, background:"rgba(255,255,255,.18)", border:"1px solid rgba(255,255,255,.35)", padding:"4px 14px", borderRadius:100, fontSize:".72rem", fontWeight:700, marginBottom:16, letterSpacing:".06em", textTransform:"uppercase" }}>
                    {theme.icon}&nbsp;&nbsp;{lead.category}
                  </div>
                  <div className="text-3xl font-black mb-2 tracking-tight" style={{ letterSpacing:"-.03em" }}>{lead.name}</div>
                  <div className="text-sm opacity-80 mb-4">{lead.city}</div>
                  {hasRating && (
                    <div style={{ display:"inline-flex", alignItems:"center", gap:8, background:"rgba(255,255,255,.15)", border:"1px solid rgba(255,255,255,.25)", padding:"6px 16px", borderRadius:100, fontSize:".85rem", marginBottom:16 }}>
                      <span style={{ color:"#fbbf24", letterSpacing:2 }}>{starsStr}</span>
                      <strong>{lead.rating.toFixed(1)}</strong>
                      <span style={{ opacity:.75 }}>Â· {lead.reviewCount} reviews</span>
                    </div>
                  )}
                  <div className="flex gap-2 justify-center flex-wrap mt-2">
                    <div style={{ background:"#fff", color:theme.pri, padding:"8px 20px", borderRadius:100, fontWeight:800, fontSize:".85rem" }}>ğŸ“ {lead.phone || "Call Now"}</div>
                    <div style={{ background:"transparent", color:"#fff", padding:"8px 20px", borderRadius:100, fontWeight:700, fontSize:".85rem", border:"2px solid rgba(255,255,255,.5)" }}>Get Free Quote â†’</div>
                  </div>
                </div>
              </div>
              {/* Services strip */}
              <div className="bg-slate-800 px-6 py-3 flex gap-4 flex-wrap justify-center">
                {["Licensed & Insured","â­ Highly Rated","Free Estimates","Fast Response"].map(t => (
                  <span key={t} className="text-xs text-slate-300 bg-slate-700 px-3 py-1 rounded-full">{t}</span>
                ))}
              </div>
            </div>
            {previewUrl && (
              <div className="flex items-center gap-2 mt-2">
                <span className="text-xs text-slate-500 font-mono truncate flex-1">{previewUrl}</span>
                <button onClick={copyLink} className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded-lg transition-colors flex-shrink-0">
                  {copied ? "âœ“ Copied" : "Copy Link"}
                </button>
                <a href={previewUrl} target="_blank" rel="noopener" className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded-lg transition-colors flex-shrink-0">â†— Open</a>
              </div>
            )}
          </div>

          {/* SHARE TABS */}
          <div>
            <div className="flex rounded-xl bg-slate-800 p-1 gap-1 mb-4">
              {[["email","ğŸ“§ Email"],["sms","ğŸ“± SMS / WhatsApp"]].map(([id,label]) => (
                <button key={id} onClick={() => setShareTab(id)}
                  className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-colors ${shareTab===id ? "bg-slate-600 text-white" : "text-slate-400 hover:text-slate-200"}`}>
                  {label}
                </button>
              ))}
            </div>

            {shareTab === "email" && (
              <div className="space-y-4">
                {/* Hook message */}
                <div>
                  <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">
                    Email Message <span className="text-slate-600 normal-case font-normal">(editable)</span>
                  </label>
                  <textarea value={hook} onChange={e => setHook(e.target.value)} rows={4}
                    className="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 resize-none leading-relaxed" />
                </div>
                {/* Email input */}
                <div>
                  <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Recipient Email</label>
                  <input type="email" value={email} onChange={e => setEmail(e.target.value)}
                    placeholder="owner@business.com"
                    className="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500" />
                  {!settings.resendApiKey && (
                    <p className="text-xs text-amber-400 mt-1.5">âš ï¸ No Resend key in Settings â€” email won't actually send, will be logged to console.</p>
                  )}
                </div>
              </div>
            )}

            {shareTab === "sms" && (
              <div className="space-y-4">
                {/* SMS message preview */}
                <div>
                  <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">
                    SMS Message <span className="text-slate-600 normal-case font-normal">({smsMsg.length} chars)</span>
                  </label>
                  <div className="bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-sm text-slate-300 leading-relaxed whitespace-pre-wrap">
                    {smsMsg}
                  </div>
                </div>

                {/* Share buttons */}
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={openWhatsApp}
                    className="flex items-center justify-center gap-2 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-semibold text-sm transition-colors">
                    <span style={{fontSize:"1.2rem"}}>ğŸ’¬</span> WhatsApp
                  </button>
                  <button onClick={openSMS}
                    className="flex items-center justify-center gap-2 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-semibold text-sm transition-colors">
                    <span style={{fontSize:"1.2rem"}}>ğŸ“±</span> SMS App
                  </button>
                </div>

                <button onClick={copySMSMsg}
                  className="w-full py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl text-sm transition-colors">
                  {copied ? "âœ“ Copied to Clipboard!" : "ğŸ“‹ Copy Message to Clipboard"}
                </button>

                {/* Twilio tip */}
                <div className="bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-4">
                  <div className="text-xs font-semibold text-indigo-400 mb-2">ğŸ’¡ Automate SMS later</div>
                  <div className="text-xs text-slate-400 leading-relaxed space-y-1">
                    <p><strong className="text-slate-300">Cheapest options (US):</strong></p>
                    <p>â€¢ <strong className="text-slate-300">Telnyx</strong> â€” ~$0.004/SMS, best rate, great API</p>
                    <p>â€¢ <strong className="text-slate-300">Twilio</strong> â€” ~$0.0079/SMS, easiest setup, most docs</p>
                    <p>â€¢ <strong className="text-slate-300">Textbelt</strong> â€” 1 free/day, $0.01 after, zero setup</p>
                    <p className="mt-2 text-slate-500">At 50 SMS/day: ~$6â€“12/month. Way cheaper than one lost customer.</p>
                  </div>
                </div>

                {/* Phone number tip */}
                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 text-xs text-slate-400">
                  <strong className="text-slate-300">Manual flow:</strong> Click WhatsApp or SMS â†’ your phone app opens with the message pre-filled â†’ just pick the contact and send. 30 seconds per lead.
                </div>
              </div>
            )}
          </div>

        </div>

        {/* Footer actions */}
        <div className="px-6 py-4 border-t border-slate-700 flex gap-3 flex-shrink-0">
          <button onClick={onClose} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm rounded-xl transition-colors">Close</button>
          <button onClick={copyLink} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm rounded-xl transition-colors">
            {copied ? "âœ“ Copied!" : "ğŸ”— Copy Link"}
          </button>
          {shareTab === "email" && (
            sent ? (
              <div className="flex-1 py-2.5 bg-emerald-700 text-white text-sm rounded-xl text-center font-semibold">âœ… Email Sent!</div>
            ) : (
              <button onClick={sendEmail} disabled={sending || !email}
                className="flex-1 py-2.5 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white text-sm rounded-xl transition-colors font-semibold">
                {sending ? "â³ Sending..." : "ğŸ“§ Send Email"}
              </button>
            )
          )}
          {shareTab === "sms" && (
            <button onClick={openWhatsApp}
              className="flex-1 py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white text-sm rounded-xl transition-colors font-semibold">
              ğŸ’¬ Open WhatsApp
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WEBSITE PREVIEW MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function WebsitePreviewModal({ lead, settings, onClose }) {
  const slug = slugify(lead.name, lead.city);
  const proj = settings?.cfProjectName || CF_DEFAULT_PROJECT;
  const deployUrl = `https://${proj}.pages.dev/${slug}`;
  const html = generateSiteHTML(lead, { siteVisible: settings?.siteVisible !== false, siteUrl: deployUrl });
  const [copied, setCopied] = React.useState(false);

  const download = () => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([html], { type: "text/html" }));
    a.download = `${slug}.html`;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  };

  const copy = () => {
    navigator.clipboard.writeText(html).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4" onClick={onClose}>
      <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-4xl shadow-2xl fade-in flex flex-col"
        style={{maxHeight:"92vh"}} onClick={e => e.stopPropagation()}>
        <div className="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
          <div className="min-w-0">
            <h3 className="text-white font-semibold truncate">{lead.name}</h3>
            <div className="text-xs text-slate-400 mt-0.5 truncate">
              Deploy URL: <a href={deployUrl} target="_blank" rel="noopener" className="text-blue-400 hover:underline">{deployUrl}</a>
            </div>
          </div>
          <div className="flex items-center gap-2 ml-4 flex-shrink-0">
            <button onClick={copy} className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded-lg transition-colors">
              {copied ? "âœ“ Copied!" : "ğŸ“‹ Copy HTML"}
            </button>
            <button onClick={download} className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded-lg transition-colors">
              â¬‡ Download
            </button>
            <button onClick={onClose} className="text-slate-400 hover:text-white text-xl ml-1">Ã—</button>
          </div>
        </div>
        <div className="flex-1 bg-slate-950 rounded-b-2xl overflow-hidden" style={{minHeight:0}}>
          <iframe srcDoc={html} className="w-full border-0" style={{height:"560px"}} title="Site Preview" />
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CEO COMMAND CENTER â€” DASHBOARD VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DashboardView({ leads, settings, addToast, onSync, syncStatus }) {
  const [triggeringN8n, setTriggeringN8n] = React.useState(false);

  const now = Date.now();
  const todayStart = new Date(); todayStart.setHours(0,0,0,0);
  const todayTs = todayStart.getTime();

  const counts = {
    total:     leads.filter(l => l.stage !== "archived").length,
    customers: leads.filter(l => l.stage === "customer").length,
    active:    leads.filter(l => ["link_sent","following_up","site_generated"].includes(l.stage)).length,
    overdue:   leads.filter(l => l.followUpAt && l.followUpAt < now && !["customer","archived"].includes(l.stage)).length,
    mrr:       leads.filter(l => l.stage === "customer").length * 5,
    new:       leads.filter(l => l.stage === "new").length,
    todayNew:  leads.filter(l => l.foundAt >= todayTs).length,
    todaySent: leads.filter(l => l.sentAt && l.sentAt >= todayTs).length,
    todayConv: leads.filter(l => l.convertedAt && l.convertedAt >= todayTs).length,
  };

  const pipeline = ["new","site_generated","link_sent","following_up","customer"].map(s => ({
    stage: s, label: STAGES[s].label,
    count: leads.filter(l => l.stage === s).length,
    color: s==="new"?"bg-indigo-500":s==="site_generated"?"bg-purple-500":
           s==="link_sent"?"bg-blue-500":s==="following_up"?"bg-amber-500":"bg-emerald-500"
  }));

  const overdueleads = leads.filter(l => l.followUpAt && l.followUpAt < now && !["customer","archived"].includes(l.stage));
  const readyToSend  = leads.filter(l => l.stage === "site_generated");
  const recent       = [...leads].filter(l => l.stage !== "archived").sort((a,b) => b.foundAt - a.foundAt).slice(0,6);

  const convRate = counts.total > 0 ? ((counts.customers / (counts.total + leads.filter(l=>l.stage==="archived").length)) * 100).toFixed(1) : 0;

  const triggerN8n = async (event) => {
    if (!settings.n8nWebhookUrl) { addToast("âš ï¸ Set n8n Webhook URL in Settings first", "error"); return; }
    setTriggeringN8n(true);
    try {
      const res = await fetch("/api/n8n-trigger", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ webhookUrl: settings.n8nWebhookUrl, payload: { event, triggeredAt: new Date().toISOString() } })
      });
      const data = await res.json();
      if (data.ok) addToast(`âœ… n8n triggered: ${event}`);
      else addToast(`n8n response: ${data.n8nResponse || "sent"}`, "success");
    } catch(e) { addToast(`n8n trigger failed: ${e.message}`, "error"); }
    finally { setTriggeringN8n(false); }
  };

  const sbConnected = !!(settings.supabaseUrl);
  const cfConnected = !!(settings.cfAccountId && settings.cfApiToken);
  const n8nConnected = !!(settings.n8nWebhookUrl);
  const emailConnected = !!(settings.resendApiKey);

  return (
    <div className="space-y-6 fade-in">

      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-2xl font-bold text-white">Command Center</h1>
          <p className="text-slate-400 text-sm mt-1">
            {new Date().toLocaleDateString("en-US", { weekday:"long", year:"numeric", month:"long", day:"numeric" })}
          </p>
        </div>
        <button onClick={onSync}
          className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm rounded-lg transition-colors">
          ğŸ”„ {syncStatus === "syncing" ? "Syncing..." : syncStatus === "ok" ? "Synced âœ“" : "Sync Supabase"}
        </button>
      </div>

      {/* System Status Bar */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-4">
        <div className="text-xs text-slate-500 font-medium mb-3 uppercase tracking-wider">System Status</div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          {[
            { label: "Supabase DB",    ok: sbConnected,    detail: sbConnected ? "Connected" : "Not configured" },
            { label: "Cloudflare",     ok: cfConnected,    detail: cfConnected ? "Ready to deploy" : "No credentials" },
            { label: "n8n Automation", ok: n8nConnected,   detail: n8nConnected ? "Webhook set" : "Not connected" },
            { label: "Email (Resend)", ok: emailConnected, detail: emailConnected ? "API key set" : "No key" },
          ].map(s => (
            <div key={s.label} className={`rounded-lg p-3 border ${s.ok ? "bg-emerald-500/5 border-emerald-500/20" : "bg-slate-900/60 border-slate-700/30"}`}>
              <div className="flex items-center gap-2 mb-0.5">
                <span className={`w-2 h-2 rounded-full flex-shrink-0 ${s.ok ? "bg-emerald-400 pulse-dot" : "bg-slate-600"}`} />
                <span className={`text-xs font-medium ${s.ok ? "text-emerald-300" : "text-slate-500"}`}>{s.label}</span>
              </div>
              <div className="text-xs text-slate-500 pl-4">{s.detail}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Today's Activity */}
      <div className="grid grid-cols-3 gap-3">
        <div className="bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-indigo-300">{counts.todayNew}</div>
          <div className="text-xs text-slate-400 mt-1">New Leads Today</div>
        </div>
        <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-blue-300">{counts.todaySent}</div>
          <div className="text-xs text-slate-400 mt-1">Emails Sent Today</div>
        </div>
        <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-emerald-300">{counts.todayConv}</div>
          <div className="text-xs text-slate-400 mt-1">Converted Today</div>
        </div>
      </div>

      {/* KPI Row */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard icon="ğŸ’°" label="MRR"           value={`$${counts.mrr}`}     sub={`${counts.customers} paying customers`} color="bg-emerald-500/20" />
        <StatCard icon="ğŸ“ˆ" label="Conversion"    value={`${convRate}%`}        sub="Leads â†’ Customers" color="bg-purple-500/20" />
        <StatCard icon="ğŸ¯" label="In Pipeline"   value={counts.active}         sub="Site sent or generated" color="bg-blue-500/20" />
        <StatCard icon="âš¡" label="Action Needed" value={counts.overdue + readyToSend.length} sub="Overdue + ready to send" color={counts.overdue > 0 ? "bg-amber-500/20" : "bg-slate-700"} />
      </div>

      {/* Revenue + Funnel */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-5">

        {/* Revenue */}
        <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
          <h3 className="text-sm font-semibold text-white mb-4">ğŸ’µ Revenue</h3>
          <div className="space-y-3">
            <div className="flex justify-between items-center py-2 border-b border-slate-700/50">
              <span className="text-sm text-slate-400">Setup Fees Earned</span>
              <span className="font-bold text-emerald-400">${counts.customers * 100}</span>
            </div>
            <div className="flex justify-between items-center py-2 border-b border-slate-700/50">
              <span className="text-sm text-slate-400">Monthly Recurring</span>
              <span className="font-bold text-blue-400">${counts.mrr}/mo</span>
            </div>
            <div className="flex justify-between items-center py-2 border-b border-slate-700/50">
              <span className="text-sm text-slate-400">Annual Run Rate</span>
              <span className="font-bold text-purple-400">${counts.customers * 100 + counts.mrr * 12}/yr</span>
            </div>
            <div className="mt-2 pt-1">
              <div className="text-xs text-slate-500 mb-1">Next milestone: {Math.max(0, 20 - counts.customers)} more customers â†’ $100/mo MRR</div>
              <div className="bg-slate-700 rounded-full h-2">
                <div className="bg-emerald-500 h-full rounded-full transition-all" style={{width: `${Math.min(100, (counts.customers/20)*100)}%`}} />
              </div>
              <div className="flex justify-between text-xs text-slate-500 mt-1">
                <span>{counts.customers} customers</span><span>20 customers</span>
              </div>
            </div>
          </div>
        </div>

        {/* Funnel */}
        <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
          <h3 className="text-sm font-semibold text-white mb-4">ğŸ¯ Pipeline Funnel</h3>
          <div className="space-y-2">
            {pipeline.map(p => (
              <div key={p.stage} className="flex items-center gap-3">
                <div className="text-xs text-slate-400 w-24 flex-shrink-0">{p.label}</div>
                <div className="flex-1 bg-slate-700 rounded-full h-5 overflow-hidden relative">
                  <div className={`h-full rounded-full transition-all ${p.color}`}
                    style={{width: counts.total ? `${Math.max(4,Math.min(100,(p.count/(counts.total+leads.filter(l=>l.stage==="archived").length))*100))}%` : "0%"}} />
                </div>
                <div className="text-sm font-bold text-white w-6 text-right">{p.count}</div>
              </div>
            ))}
          </div>
          <div className="mt-3 text-xs text-slate-500">{leads.filter(l=>l.stage==="archived").length} archived Â· {leads.length} total scraped</div>
        </div>
      </div>

      {/* Action Items */}
      {(overdueleads.length > 0 || readyToSend.length > 0) && (
        <div className="bg-amber-500/5 border border-amber-500/20 rounded-xl p-5">
          <h3 className="text-sm font-semibold text-amber-300 mb-3">âš¡ Needs Your Attention</h3>
          <div className="space-y-2">
            {overdueleads.slice(0,3).map(l => (
              <div key={l.id} className="flex items-center justify-between bg-slate-800/60 rounded-lg px-3 py-2.5">
                <div>
                  <span className="text-sm text-white">{l.name}</span>
                  <span className="text-xs text-slate-400 ml-2">{l.city}</span>
                </div>
                <span className="text-xs text-amber-400 bg-amber-500/10 px-2 py-0.5 rounded-full">Follow-up overdue</span>
              </div>
            ))}
            {readyToSend.slice(0,3).map(l => (
              <div key={l.id} className="flex items-center justify-between bg-slate-800/60 rounded-lg px-3 py-2.5">
                <div>
                  <span className="text-sm text-white">{l.name}</span>
                  <span className="text-xs text-slate-400 ml-2">{l.city}</span>
                </div>
                <span className="text-xs text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded-full">Site ready â€” send preview</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Quick Actions */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h3 className="text-sm font-semibold text-white mb-4">ğŸš€ Quick Actions</h3>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
          <button onClick={() => triggerN8n("daily_search")} disabled={triggeringN8n || !n8nConnected}
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 disabled:opacity-50 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all text-left">
            <span className="text-lg">ğŸ”</span>
            <span className="text-sm font-medium text-white">Run Lead Search</span>
            <span className="text-xs text-slate-500">Trigger n8n daily search</span>
          </button>
          <button onClick={() => triggerN8n("send_followups")} disabled={triggeringN8n || !n8nConnected}
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 disabled:opacity-50 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all text-left">
            <span className="text-lg">ğŸ“§</span>
            <span className="text-sm font-medium text-white">Send Follow-ups</span>
            <span className="text-xs text-slate-500">Email overdue leads now</span>
          </button>
          <button onClick={() => triggerN8n("archive_cold")} disabled={triggeringN8n || !n8nConnected}
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 disabled:opacity-50 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all text-left">
            <span className="text-lg">ğŸ“</span>
            <span className="text-sm font-medium text-white">Archive Cold Leads</span>
            <span className="text-xs text-slate-500">Clean up 14+ day no-response</span>
          </button>
          <a href={`https://${settings.cfProjectName || "hashtagwebpage"}.pages.dev`} target="_blank" rel="noopener"
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all">
            <span className="text-lg">ğŸŒ</span>
            <span className="text-sm font-medium text-white">View Marketing Site</span>
            <span className="text-xs text-slate-500">hashtagwebpage.pages.dev</span>
          </a>
          <a href="http://localhost:5678" target="_blank" rel="noopener"
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all">
            <span className="text-lg">âš™ï¸</span>
            <span className="text-sm font-medium text-white">Open n8n</span>
            <span className="text-xs text-slate-500">Manage automations</span>
          </a>
          <a href="http://localhost:54323" target="_blank" rel="noopener"
            className="flex flex-col items-start gap-1 p-3 bg-slate-900 hover:bg-slate-700 rounded-xl border border-slate-700/50 hover:border-slate-500 transition-all">
            <span className="text-lg">ğŸ—„ï¸</span>
            <span className="text-sm font-medium text-white">Open pgAdmin</span>
            <span className="text-xs text-slate-500">Browse database</span>
          </a>
        </div>
      </div>

      {/* Recent Leads */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h3 className="text-sm font-semibold text-white mb-3">ğŸ• Recent Leads</h3>
        <div className="space-y-2">
          {recent.map(l => {
            const daysAgo = Math.floor((now - l.foundAt) / 86400000);
            return (
              <div key={l.id} className="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-0">
                <div className="flex-1 min-w-0">
                  <div className="text-sm text-white truncate">{l.name}</div>
                  <div className="text-xs text-slate-500">{l.category} Â· {l.city}</div>
                </div>
                <div className="flex items-center gap-2 flex-shrink-0 ml-2">
                  <span className="text-xs text-slate-600">{daysAgo === 0 ? "Today" : `${daysAgo}d ago`}</span>
                  <Badge stage={l.stage} />
                </div>
              </div>
            );
          })}
          {leads.length === 0 && (
            <p className="text-slate-500 text-sm py-2">No leads yet. Use Find Leads to start your pipeline.</p>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIND LEADS VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FindLeadsView({ leads, onAddLeads }) {
  const [city, setCity] = React.useState("");
  const [category, setCategory] = React.useState("Plumber");
  const [loading, setLoading] = React.useState(false);
  const [results, setResults] = React.useState([]);
  const [error, setError] = React.useState(null);
  const [added, setAdded] = React.useState(new Set());

  const search = async () => {
    if (!city.trim()) { setError("Please enter a city"); return; }
    const googleApiKey = (store.getSettings().googleApiKey || "").trim();
    if (!googleApiKey) {
      setError("No Google API key set. Go to Settings â†’ Google Places API and add your key.");
      return;
    }
    setLoading(true); setError(null); setResults([]);
    try {
      const fieldMask = [
        "places.id","places.displayName","places.formattedAddress",
        "places.nationalPhoneNumber","places.rating","places.userRatingCount",
        "places.websiteUri","places.googleMapsUri","places.primaryType"
      ].join(",");

      const res = await fetch("https://places.googleapis.com/v1/places:searchText", {
        method: "POST",
        headers: {
          "Content-Type":    "application/json",
          "X-Goog-Api-Key":  googleApiKey,
          "X-Goog-FieldMask": fieldMask
        },
        body: JSON.stringify({ textQuery: `${category} in ${city.trim()}`, maxResultCount: 20 })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error?.message || `Places API error ${res.status}`);

      const places = (data.places || []).filter(p => !p.websiteUri);
      if (!places.length) {
        setError(`No businesses without websites found in ${city.trim()} for ${category}. Try a different city.`);
      } else {
        setResults(places.map(p => ({
          id: p.id,
          name: p.displayName?.text || "Unknown Business",
          category, city: city.trim(),
          phone: p.nationalPhoneNumber || null,
          address: p.formattedAddress || "",
          rating: p.rating || 0,
          reviewCount: p.userRatingCount || 0,
          hasWebsite: false,
          stage: "new",
          mapsUrl: p.googleMapsUri || "#",
          foundAt: Date.now(),
          sentAt: null, followUpAt: null, convertedAt: null,
          previewUrl: null, email: null, notes: ""
        })));
      }
    } catch (e) {
      setError(`Search failed: ${e.message}`);
    } finally { setLoading(false); }
  };

  const loadDemo = () => {
    const c = city.trim() || "Atlanta, GA";
    setResults([
      { id:"demo_"+Date.now(), name:"Tom's "+category+" Co", category, city:c,
        phone:"(555) 123-4567", address:"123 Main St, "+c, rating:4.6, reviewCount:22,
        hasWebsite:false, stage:"new", mapsUrl:"#", foundAt:Date.now(),
        sentAt:null, followUpAt:null, convertedAt:null, previewUrl:null, email:null, notes:"" },
      { id:"demo2_"+Date.now(), name:c.split(",")[0]+" "+category+" Services", category, city:c,
        phone:"(555) 987-6543", address:"456 Oak Ave, "+c, rating:4.8, reviewCount:67,
        hasWebsite:false, stage:"new", mapsUrl:"#", foundAt:Date.now(),
        sentAt:null, followUpAt:null, convertedAt:null, previewUrl:null, email:null, notes:"" }
    ]);
    setError(null);
  };

  const addToLeads = r => {
    if (!leads.find(l => l.id === r.id)) onAddLeads([r]);
    setAdded(prev => new Set([...prev, r.id]));
  };
  const addAll = () => {
    const newOnes = results.filter(r => !leads.find(l => l.id === r.id));
    if (newOnes.length) onAddLeads(newOnes);
    setAdded(new Set(results.map(r => r.id)));
  };

  return (
    <div className="space-y-6 fade-in">
      <div>
        <h1 className="text-2xl font-bold text-white">Find Leads</h1>
        <p className="text-slate-400 text-sm mt-1">Search Google Maps for businesses without websites</p>
      </div>

      <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 text-sm text-blue-300">
        ğŸ’¡ <strong>Cost-optimized:</strong> Each search costs ~$0.01 via Google Places API and is cached for 7 days.
      </div>

      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label className="text-xs text-slate-400 mb-1.5 block">City</label>
            <input value={city} onChange={e => setCity(e.target.value)} onKeyDown={e => e.key==="Enter"&&search()}
              placeholder="e.g. Atlanta, GA"
              className="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500" />
          </div>
          <div>
            <label className="text-xs text-slate-400 mb-1.5 block">Category</label>
            <select value={category} onChange={e => setCategory(e.target.value)}
              className="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500">
              {CATEGORIES.map(c => <option key={c}>{c}</option>)}
            </select>
          </div>
          <div className="flex items-end gap-2">
            <button onClick={search} disabled={loading}
              className="flex-1 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white py-2.5 px-4 rounded-lg text-sm font-medium transition-colors">
              {loading ? <span className="inline-block spin">â³</span> : "ğŸ” Search"}
            </button>
            <button onClick={loadDemo} className="bg-slate-700 hover:bg-slate-600 text-slate-300 py-2.5 px-3 rounded-lg text-sm transition-colors">Demo</button>
          </div>
        </div>
        {error && <div className="mt-3 text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-3">{error}</div>}
      </div>

      {results.length > 0 && (
        <div>
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm text-slate-400">{results.length} businesses found without websites</div>
            <button onClick={addAll} className="text-sm bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-lg transition-colors">Add All</button>
          </div>
          <div className="grid gap-3 sm:grid-cols-2">
            {results.map(r => (
              <div key={r.id} className={`bg-slate-800/80 border rounded-xl p-4 fade-in ${added.has(r.id)?"border-emerald-500/40":"border-slate-700/50"}`}>
                <div className="flex justify-between items-start">
                  <div>
                    <div className="font-medium text-white text-sm">{r.name}</div>
                    <div className="text-xs text-slate-400">{r.category} Â· {r.city}</div>
                  </div>
                  {r.rating > 0 && <StarRating rating={r.rating} />}
                </div>
                {r.phone && <div className="text-xs text-slate-400 mt-2">ğŸ“ {r.phone}</div>}
                <div className="text-xs text-slate-500 mt-1 truncate">ğŸ“ {r.address}</div>
                <div className="mt-3">
                  {added.has(r.id)
                    ? <span className="text-xs text-emerald-400">âœ“ Added to pipeline</span>
                    : <button onClick={() => addToLeads(r)} className="w-full text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg transition-colors">+ Add to Pipeline</button>}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PIPELINE VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PipelineView({ leads, onAction, onSelect, onSendPreview, deploying }) {
  const stageOrder = ["new","site_generated","link_sent","following_up","customer","archived"];
  return (
    <div className="fade-in">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-white">Pipeline</h1>
        <p className="text-slate-400 text-sm mt-1">Manage leads through your workflow</p>
      </div>
      <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide" style={{minHeight:"70vh"}}>
        {stageOrder.map(stage => {
          const stageLeads = leads.filter(l => l.stage === stage);
          const s = STAGES[stage];
          return (
            <div key={stage} className="flex-shrink-0 w-72">
              <div className="flex items-center justify-between mb-3 px-1">
                <span className={`text-sm font-semibold ${s.text}`}>{s.label}</span>
                <span className={`text-xs px-2 py-0.5 rounded-full ${s.bg} ${s.text}`}>{stageLeads.length}</span>
              </div>
              <div className="space-y-3 min-h-[200px]">
                {stageLeads.map(lead => (
                  <LeadCard key={lead.id} lead={lead} onAction={onAction} onSelect={onSelect} onSendPreview={onSendPreview} deploying={deploying} />
                ))}
                {stageLeads.length === 0 && (
                  <div className={`border-2 border-dashed ${s.border} rounded-xl h-24 flex items-center justify-center`}>
                    <span className="text-xs text-slate-600">No leads here</span>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SETTINGS VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module-level so React never remounts on re-render
function SettingsField({ k, label, placeholder, type, help, form, set }) {
  return (
    <div>
      <label className="text-sm text-slate-300 mb-1.5 block font-medium">{label}</label>
      <input type={type || "text"} value={form[k] || ""} onChange={e => set(k, e.target.value)}
        placeholder={placeholder}
        className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500" />
      {help && <p className="text-xs text-slate-500 mt-1">{help}</p>}
    </div>
  );
}

function SettingsView({ settings, onSave, addToast }) {
  const [form, setForm] = React.useState({
    googleApiKey:  settings.googleApiKey  || "",
    cfPagesDomain: settings.cfPagesDomain || "",
    cfAccountId:   settings.cfAccountId   || "",
    cfApiToken:    settings.cfApiToken    || "",
    cfProjectName: settings.cfProjectName || CF_DEFAULT_PROJECT,
    githubOwner:   settings.githubOwner   || "",
    githubRepo:    settings.githubRepo    || "",
    githubToken:   settings.githubToken   || "",
    resendApiKey:  settings.resendApiKey  || "",
    fromEmail:     settings.fromEmail     || "hello@hashtagwebpage.co",
    n8nWebhookUrl: settings.n8nWebhookUrl || "",
    supabaseUrl:   settings.supabaseUrl   || "http://localhost:54321",
    supabaseKey:   settings.supabaseKey   || "",
    siteVisible:   settings.siteVisible   !== false,
  });
  const [saved, setSaved] = React.useState(false);
  const [testingDb, setTestingDb] = React.useState(false);
  const [deployingHome, setDeployingHome] = React.useState(false);
  const manifest = settings.cfManifest || {};
  const manifestKeys = Object.keys(manifest);

  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));

  const save = () => {
    onSave({ ...settings, ...form });
    setSaved(true);
    setTimeout(() => setSaved(false), 2500);
  };

  const testDb = async () => {
    if (!form.supabaseUrl) { addToast("Enter a Supabase URL first", "error"); return; }
    setTestingDb(true);
    try {
      const headers = {};
      if (form.supabaseKey) headers["apikey"] = form.supabaseKey;
      const res = await fetch(form.supabaseUrl.replace(/\/$/, "") + "/rest/v1/leads?limit=1", { headers });
      if (res.ok || res.status === 406) addToast("âœ… Supabase connection OK!");
      else addToast(`Connection failed (${res.status})`, "error");
    } catch (e) {
      addToast(`Connection failed: ${e.message}`, "error");
    } finally { setTestingDb(false); }
  };

  const deployHomepage = async () => {
    setDeployingHome(true);
    try {
      const res = await fetch("/api/deploy-home", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          cfPagesDomain: form.cfPagesDomain || "hashtagwebpage.pages.dev"
        })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error || "Deploy failed");
      onSave({ ...settings, ...form });
      addToast(`âœ… Homepage ${data.gitPushed ? "pushed to GitHub" : "saved locally"} â†’ ${data.productionUrl}`);
    } catch (e) {
      addToast(`Homepage deploy failed: ${e.message}`, "error");
    } finally { setDeployingHome(false); }
  };


  return (
    <div className="space-y-6 fade-in max-w-2xl">
      <div>
        <h1 className="text-2xl font-bold text-white">Settings</h1>
        <p className="text-slate-400 text-sm mt-1">Configure API keys and integrations</p>
      </div>

      {/* Google API */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ” Google Places API</h2>
        <p className="text-xs text-slate-500 mb-4">
          Required for lead scraping. Get a free key at{" "}
          <a href="https://console.cloud.google.com/apis/library/places-backend.googleapis.com" target="_blank" rel="noopener" className="text-indigo-400 hover:underline">Google Cloud Console</a>
          {" "}â€” enable the <strong className="text-slate-300">Places API (New)</strong>. ~$0.01/search.
        </p>
        <SettingsField k="googleApiKey" label="API Key" placeholder="AIzaSy..." type="password" help="Google Cloud Console â†’ APIs & Services â†’ Credentials" form={form} set={set} />
        {!form.googleApiKey && (
          <p className="mt-2 text-xs text-amber-400">âš ï¸ No API key set â€” searches will fail until you add one here and restart the server</p>
        )}
      </div>

      {/* Cloudflare */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">â˜ï¸ Cloudflare Pages</h2>
        <p className="text-xs text-slate-500 mb-4">
          Sites deploy via GitHub â†’ CF Pages auto-deploys in ~30s. Set your domain below
          so generated links use <code className="text-indigo-400 mx-1">hashtagwebpage.com/business-slug</code>
          or <code className="text-indigo-400 mx-1">hashtagwebpage.pages.dev/business-slug</code>.
        </p>
        <div className="space-y-3">
          <SettingsField k="cfPagesDomain" label="Pages Domain" placeholder="hashtagwebpage.com" help="Your CF Pages domain â€” hashtagwebpage.com or hashtagwebpage.pages.dev" form={form} set={set} />
          <SettingsField k="cfProjectName" label="CF Project Name" placeholder="hashtagwebpage"  help="CF Pages project name (same as GitHub repo CF Pages is connected to)" form={form} set={set} />
          <SettingsField k="githubOwner"   label="GitHub Owner"    placeholder="yourusername"    help="Your GitHub username or org (e.g. appsparrow)" form={form} set={set} />
          <SettingsField k="githubRepo"    label="GitHub Repo"     placeholder="hashtagwebpage"  help="The repo CF Pages deploys from (e.g. hashtagwebpage)" form={form} set={set} />
          <SettingsField k="githubToken"   label="GitHub Token"    placeholder="ghp_xxxx..."     type="password" help="Personal Access Token with Contents:Write scope â€” github.com/settings/tokens" form={form} set={set} />
        </div>

        {/* Manifest */}
        <div className="mt-4 bg-slate-900 rounded-lg p-3">
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs text-slate-400 font-medium">Deployed Manifest</span>
            <span className="text-xs text-slate-500">{manifestKeys.length} path{manifestKeys.length !== 1 ? "s" : ""} cached</span>
          </div>
          {manifestKeys.length > 0 ? (
            <div className="max-h-28 overflow-y-auto scrollbar-hide space-y-0.5">
              {manifestKeys.map(p => (
                <div key={p} className="text-xs font-mono text-slate-400 truncate">
                  <span className="text-emerald-400">âœ“</span> {p}
                </div>
              ))}
            </div>
          ) : (
            <p className="text-xs text-slate-600">No sites deployed yet.</p>
          )}
        </div>

        <div className="mt-4 flex gap-2">
          <button onClick={deployHomepage} disabled={deployingHome}
            className="flex-1 py-2.5 bg-orange-600 hover:bg-orange-500 disabled:opacity-60 text-white text-sm font-medium rounded-lg transition-colors">
            {deployingHome ? <span className="inline-block spin mr-1">â³</span> : "ğŸ  "}Deploy Homepage
          </button>
          <a href={`https://${form.cfProjectName || CF_DEFAULT_PROJECT}.pages.dev`} target="_blank" rel="noopener"
            className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm rounded-lg transition-colors flex items-center gap-1">
            â†— View
          </a>
        </div>
        <p className="text-xs text-slate-500 mt-1.5">Deploys <code>hashtagwebpage-home.html</code> as the public homepage</p>
      </div>

      {/* Supabase */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ—„ï¸ Supabase (Optional)</h2>
        <p className="text-xs text-slate-500 mb-4">Sync leads across devices. Works with local or cloud Supabase.</p>
        <div className="space-y-3">
          <SettingsField k="supabaseUrl" label="Supabase URL"      placeholder="http://localhost:54321" help="Local: http://localhost:54321 Â· Cloud: https://xyz.supabase.co" form={form} set={set} />
          <SettingsField k="supabaseKey" label="Anon Key (optional)" placeholder="eyJ..."  type="password" help="Leave blank for local PostgREST with no JWT secret" form={form} set={set} />
        </div>
        <div className="mt-3 bg-slate-900 rounded-lg p-3 text-xs text-slate-500">
          <span className="text-slate-400 font-medium">After changing JWT settings, run: </span>
          <code className="text-emerald-400">docker compose up -d --force-recreate rest</code>
        </div>
        <button onClick={testDb} disabled={testingDb}
          className="mt-3 px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-60 text-slate-300 text-sm rounded-lg transition-colors">
          {testingDb ? <span className="inline-block spin mr-1">â³</span> : "ğŸ”Œ "}Test Connection
        </button>
      </div>

      {/* Email */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-4">ğŸ“§ Email â€” Resend.com</h2>
        <p className="text-sm text-slate-400 mb-3">
          <a href="https://resend.com" target="_blank" rel="noopener" className="text-blue-400 hover:underline">resend.com</a> â€” 100 free emails/day
        </p>
        <div className="space-y-3">
          <SettingsField k="resendApiKey" label="Resend API Key" placeholder="re_..." type="password" form={form} set={set} />
          <SettingsField k="fromEmail"    label="From Email"     placeholder="contact@hashtagwebpage.com" form={form} set={set} />
        </div>
      </div>

      {/* n8n */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-4">ğŸ”„ n8n Automation</h2>
        <SettingsField k="n8nWebhookUrl" label="n8n Webhook URL" placeholder="http://localhost:5678/webhook/hashtagwebpage" form={form} set={set} />
      </div>

      {/* Site Visibility */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ”’ Site Visibility</h2>
        <p className="text-xs text-slate-500 mb-4">
          When <strong className="text-slate-300">off</strong>, all generated sites get a "Preview Mode" banner and <code className="text-indigo-400">noindex</code> tag â€” search engines won't index them. Turn <strong className="text-slate-300">on</strong> when you're ready to accept payments and go live.
        </p>
        <label className="flex items-center gap-3 cursor-pointer select-none group">
          <div
            onClick={() => set("siteVisible", !form.siteVisible)}
            className={`relative w-12 h-6 rounded-full transition-colors ${form.siteVisible ? "bg-emerald-500" : "bg-slate-600"}`}
          >
            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${form.siteVisible ? "translate-x-6" : "translate-x-0.5"}`} />
          </div>
          <div>
            <div className={`text-sm font-semibold ${form.siteVisible ? "text-emerald-400" : "text-amber-400"}`}>
              {form.siteVisible ? "âœ… Sites are Public â€” Ready to Accept Customers" : "âš ï¸ Preview Mode â€” Sites hidden from search engines"}
            </div>
            <div className="text-xs text-slate-500 mt-0.5">
              {form.siteVisible ? "New sites will deploy without the preview banner." : "New sites will show a 'Preview Mode' banner and won't be indexed."}
            </div>
          </div>
        </label>
        <p className="text-xs text-slate-600 mt-3">âš ï¸ Changing this only affects newly generated sites. Re-generate existing leads to apply.</p>
      </div>

      {/* Published Sites Directory */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ—‚ï¸ Published Sites Directory</h2>
        <p className="text-xs text-slate-500 mb-4">
          A hidden admin page listing every published site pulled live from Supabase. Not linked anywhere publicly â€” access it directly.
        </p>
        <div className="flex flex-wrap gap-3">
          <a
            href={`https://${settings.cfPagesDomain || "hashtagwebpage.pages.dev"}/_sites/`}
            target="_blank" rel="noopener"
            className="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold px-4 py-2 rounded-lg transition-colors"
          >
            â†— Open Sites Directory
          </a>
          <button
            onClick={() => { navigator.clipboard.writeText(`https://${settings.cfPagesDomain || "hashtagwebpage.pages.dev"}/_sites/`); addToast("Link copied!"); }}
            className="inline-flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium px-4 py-2 rounded-lg transition-colors"
          >
            Copy Link
          </button>
        </div>
        <p className="text-xs text-slate-600 mt-3">First visit prompts for your Supabase URL + anon key (stored in browser only).</p>
      </div>

      {/* Delete Records */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ—‘ï¸ Clear Demo Data</h2>
        <p className="text-xs text-slate-500 mb-4">
          Run these SQL commands in pgAdmin (<a href="http://localhost:5050" target="_blank" rel="noopener" className="text-indigo-400 hover:underline">localhost:5050</a>) â†’ hashtagwebpage â†’ Query Tool:
        </p>
        <div className="space-y-3">
          <div>
            <div className="text-xs text-slate-400 font-medium mb-1">Delete ALL leads:</div>
            <div className="bg-slate-900 rounded-lg px-4 py-3 font-mono text-sm text-emerald-400 flex items-center justify-between gap-3">
              <span>DELETE FROM leads;</span>
              <button onClick={() => { navigator.clipboard.writeText("DELETE FROM leads;"); addToast("Copied to clipboard"); }}
                className="text-xs text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded transition-colors flex-shrink-0">
                Copy
              </button>
            </div>
          </div>
          <div>
            <div className="text-xs text-slate-400 font-medium mb-1">Delete only test/demo leads (not yet customers):</div>
            <div className="bg-slate-900 rounded-lg px-4 py-3 font-mono text-sm text-emerald-400 flex items-center justify-between gap-3">
              <span className="break-all">{"DELETE FROM leads WHERE stage != 'customer';"}</span>
              <button onClick={() => { navigator.clipboard.writeText("DELETE FROM leads WHERE stage != 'customer';"); addToast("Copied to clipboard"); }}
                className="text-xs text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded transition-colors flex-shrink-0">
                Copy
              </button>
            </div>
          </div>
          <div>
            <div className="text-xs text-slate-400 font-medium mb-1">Reset sequence (run after delete):</div>
            <div className="bg-slate-900 rounded-lg px-4 py-3 font-mono text-sm text-slate-400 flex items-center justify-between gap-3">
              <span>ALTER SEQUENCE leads_id_seq RESTART WITH 1;</span>
              <button onClick={() => { navigator.clipboard.writeText("ALTER SEQUENCE leads_id_seq RESTART WITH 1;"); addToast("Copied to clipboard"); }}
                className="text-xs text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded transition-colors flex-shrink-0">
                Copy
              </button>
            </div>
          </div>
        </div>
        <p className="text-xs text-slate-600 mt-3">Also refresh the app (F5) to clear any cached leads from localStorage.</p>
      </div>

      {/* Hero Images */}
      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-5">
        <h2 className="text-base font-semibold text-white mb-1">ğŸ–¼ï¸ Category Hero Images</h2>
        <p className="text-xs text-slate-500 mb-3">
          Place hero images in <code className="text-indigo-400">webapp/sites/assets/categories/</code> â€” named after the category slug. They'll automatically appear as the hero background on generated sites.
        </p>
        <div className="bg-slate-900 rounded-lg p-3 text-xs font-mono space-y-1 text-slate-400">
          <div><span className="text-emerald-400">plumber.jpg</span> â†’ Plumber sites</div>
          <div><span className="text-emerald-400">electrician.jpg</span> â†’ Electrician sites</div>
          <div><span className="text-emerald-400">house-cleaning.jpg</span> â†’ House Cleaning sites</div>
          <div><span className="text-emerald-400">pest-control.jpg</span> â†’ Pest Control sites</div>
          <div><span className="text-slate-600">... etc (lowercase, hyphens, no spaces)</span></div>
        </div>
        <p className="text-xs text-slate-600 mt-3">If no image is found for a category, the gradient hero shows cleanly as a fallback.</p>
      </div>

      {/* Pricing */}
      <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-4">
        <h3 className="text-sm font-semibold text-emerald-400 mb-2">ğŸ’° Pricing Model</h3>
        <div className="text-sm text-slate-300 space-y-1">
          <p>â€¢ <strong>Free preview</strong> â€” business sees their site with no obligation</p>
          <p>â€¢ <strong>$100 setup fee</strong> â€” domain setup + 2 months hosting included</p>
          <p>â€¢ <strong>$5/month</strong> hosting on <code>hashtagwebpage.pages.dev/slug</code></p>
          <p>â€¢ <strong>$200 buyout</strong> â€” custom domain, transferred to them</p>
        </div>
      </div>

      <button onClick={save}
        className={`px-6 py-3 rounded-xl font-medium text-sm transition-all ${saved ? "bg-emerald-600 text-white" : "bg-indigo-600 hover:bg-indigo-500 text-white"}`}>
        {saved ? "âœ“ Saved!" : "Save Settings"}
      </button>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN FIELD â€” defined at module level so React never remounts it
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginField({ label, value, onChange, type, placeholder }) {
  return (
    <div style={{ marginBottom: "14px" }}>
      <label style={{ display:"block", fontSize:"12px", fontWeight:600, color:"#94a3b8", marginBottom:"6px", letterSpacing:".03em" }}>{label}</label>
      <input
        type={type || "text"} value={value}
        onChange={e => onChange(e.target.value)}
        placeholder={placeholder} autoComplete="off"
        style={{ width:"100%", background:"#0f172a", border:"1px solid #334155", borderRadius:"8px",
          padding:"10px 14px", fontSize:"14px", color:"#f1f5f9", outline:"none", fontFamily:"inherit",
          boxSizing:"border-box" }}
        onFocus={e => e.target.style.borderColor="#6366f1"}
        onBlur={e  => e.target.style.borderColor="#334155"}
      />
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN SCREEN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen({ onLogin }) {
  const [email,  setEmail]  = React.useState("");
  const [pass,   setPass]   = React.useState("");
  const [error,  setError]  = React.useState("");
  const [loading,setLoading]= React.useState(false);

  // Resolve Supabase config: hardcoded constants â†’ localStorage Settings fallback
  const resolvedUrl = SUPABASE_URL || store.getSettings().supabaseUrl || "";
  const resolvedKey = SUPABASE_ANON_KEY || store.getSettings().supabaseKey || "";

  const handleLogin = async (e) => {
    e.preventDefault();
    if (!resolvedUrl || !resolvedKey) {
      setError("Supabase not configured. Set SUPABASE_URL and SUPABASE_ANON_KEY in index.html before deploying.");
      return;
    }
    if (!email || !pass) { setError("Enter your email and password."); return; }
    setError(""); setLoading(true);
    try {
      await auth.signIn(resolvedUrl, resolvedKey, email.trim(), pass);
      onLogin();
    } catch (err) {
      setError(err.message || "Login failed");
    } finally { setLoading(false); }
  };

  return (
    <div style={{ minHeight:"100vh", background:"#0f172a", display:"flex", alignItems:"center", justifyContent:"center", padding:"20px", fontFamily:"'Inter',system-ui,sans-serif" }}>
      <div style={{ width:"100%", maxWidth:"400px" }}>
        {/* Logo */}
        <div style={{ textAlign:"center", marginBottom:"32px" }}>
          <div style={{ fontSize:"28px", fontWeight:800, color:"#f1f5f9", letterSpacing:"-.03em" }}>
            <span style={{ color:"#6366f1" }}>#</span>HashtagWebpage
          </div>
          <div style={{ fontSize:"13px", color:"#475569", marginTop:"6px" }}>CRM Â· Admin Access</div>
        </div>

        {/* Card */}
        <form onSubmit={handleLogin} style={{ background:"#1e293b", border:"1px solid #334155", borderRadius:"16px", padding:"32px" }}>
          <h2 style={{ fontSize:"18px", fontWeight:700, color:"#f1f5f9", marginBottom:"20px", marginTop:0 }}>Sign in</h2>

          <LoginField label="EMAIL"    value={email} onChange={setEmail} placeholder="you@hashtagwebpage.com" type="email" />
          <LoginField label="PASSWORD" value={pass}  onChange={setPass}  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" type="password" />

          {error && (
            <div style={{ background:"#7f1d1d22", border:"1px solid #ef4444", color:"#fca5a5", borderRadius:"8px", padding:"10px 14px", fontSize:"13px", marginBottom:"16px" }}>
              {error}
            </div>
          )}

          <button type="submit" disabled={loading}
            style={{ width:"100%", background: loading ? "#4338ca" : "#6366f1", color:"white", border:"none", borderRadius:"8px",
              padding:"12px", fontSize:"15px", fontWeight:700, cursor: loading ? "not-allowed" : "pointer",
              transition:"background .15s", marginTop:"4px" }}>
            {loading ? "Signing inâ€¦" : "Sign in â†’"}
          </button>
        </form>
      </div>
    </div>
  );
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN APP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [authed, setAuthed]           = React.useState(() => !!auth.getSession());
  const [view, setView]               = React.useState("dashboard");
  const [leads, setLeads]             = React.useState(() => store.getLeads());
  const [settings, setSettings]       = React.useState(() => store.getSettings());
  const [selectedLead, setSelectedLead]       = React.useState(null);
  const [previewLead, setPreviewLead]         = React.useState(null);
  const [sendPreviewLead, setSendPreviewLead] = React.useState(null);
  const [sidebarOpen, setSidebarOpen]         = React.useState(true);
  const [deploying, setDeploying]     = React.useState(new Set());
  const [toasts, setToasts]           = React.useState([]);
  const [syncStatus, setSyncStatus]   = React.useState("idle"); // idle | syncing | ok | error

  if (!authed) return <LoginScreen onLogin={() => { setSettings(store.getSettings()); setAuthed(true); }} />;

  const addToast = (msg, type = "success") => {
    const id = Date.now() + Math.random();
    setToasts(prev => [...prev, { id, msg, type }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4500);
  };

  const saveLeads    = nl => { setLeads(nl); store.saveLeads(nl); };
  const saveSettings = s  => { setSettings(s); store.saveSettings(s); };

  // â”€â”€ Sync from Supabase (manual or on settings change) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const syncFromSupabase = React.useCallback(async (currentSettings) => {
    const s = currentSettings || settings;
    if (!s.supabaseUrl) { addToast("âš ï¸ Configure Supabase URL in Settings first", "error"); return; }
    setSyncStatus("syncing");
    try {
      const sbLeads = await loadAllFromSupabase(s);
      if (sbLeads && sbLeads.length > 0) {
        // Merge: Supabase is source of truth, keep local-only leads
        const sbIds = new Set(sbLeads.map(l => l.id));
        const localOnly = store.getLeads().filter(l => !sbIds.has(l.id) && l.id.startsWith("demo_"));
        const merged = [...sbLeads, ...localOnly];
        saveLeads(merged);
        addToast(`âœ… Synced ${sbLeads.length} leads from Supabase`);
      } else if (sbLeads && sbLeads.length === 0) {
        addToast("Supabase connected â€” no leads yet (table empty)");
      }
      setSyncStatus("ok");
      setTimeout(() => setSyncStatus("idle"), 5000);
    } catch(e) {
      setSyncStatus("error");
      addToast(`Sync failed: ${e.message}`, "error");
    }
  }, [settings]);

  // Auto-sync from Supabase on startup if configured
  React.useEffect(() => {
    if (settings.supabaseUrl) {
      syncFromSupabase(settings);
    }
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // Poll for n8n-added leads every 30s
  React.useEffect(() => {
    const poll = async () => {
      try {
        const res = await fetch("/api/leads");
        const data = await res.json();
        if (data.leads?.length) {
          setLeads(prev => {
            const merged = [...prev];
            let changed = false;
            data.leads.forEach(nl => { if (!merged.find(l => l.id === nl.id)) { merged.push(nl); changed = true; } });
            if (changed) { store.saveLeads(merged); return merged; }
            return prev;
          });
        }
      } catch {}
    };
    poll();
    const iv = setInterval(poll, 30000);
    return () => clearInterval(iv);
  }, []);

  // â”€â”€ Main action handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleAction = async (id, action) => {
    // ASYNC: Generate & deploy site
    if (action === "generate") {
      const lead = leads.find(l => l.id === id);
      if (!lead) return;
      if (!settings.githubToken || !settings.githubOwner || !settings.githubRepo) {
        addToast("âš ï¸ Add GitHub Owner, Repo and Token in Settings first", "error");
        return;
      }
      const slug           = slugify(lead.name, lead.city);
      const domain         = settings.cfPagesDomain || "hashtagwebpage.pages.dev";
      const siteUrl        = `https://${domain}/${slug}`;
      const html           = generateSiteHTML(lead, { siteVisible: settings.siteVisible !== false, siteUrl });

      setDeploying(prev => new Set([...prev, id]));
      try {
        const productionUrl = await deployViaGitHub(slug, html, settings);

        const newSettings = { ...settings };
        saveSettings(newSettings);

        const newLeads = leads.map(l => l.id === id ? { ...l, stage: "site_generated", previewUrl: productionUrl } : l);
        saveLeads(newLeads);

        const updated = newLeads.find(l => l.id === id);
        if (settings.supabaseUrl && updated) dbSaveLead(updated, newSettings).catch(() => {});

        addToast(`âœ… Pushed to GitHub â†’ ${productionUrl} (CF Pages deployingâ€¦)`);
      } catch (e) {
        addToast(`Deploy failed: ${e.message}`, "error");
      } finally {
        setDeploying(prev => { const s = new Set(prev); s.delete(id); return s; });
      }
      return;
    }

    // SYNC: All other actions
    const now = Date.now();
    const newLeads = leads.map(l => {
      if (l.id !== id) return l;
      if (action === "send_link") {
        const updated = { ...l, stage: "link_sent", sentAt: now, followUpAt: now + 7 * 86400000 };
        // Trigger n8n
        if (settings.n8nWebhookUrl) {
          fetch("/api/n8n-trigger", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ webhookUrl: settings.n8nWebhookUrl, payload: { event: "link_sent", lead: updated } })
          }).catch(() => {});
        }
        return updated;
      }
      if (action === "convert") return { ...l, stage: "customer", convertedAt: now, followUpAt: null };
      if (action === "archive") return { ...l, stage: "archived" };
      if (action === "reset")   return { ...l, stage: "new", previewUrl: null, sentAt: null, followUpAt: null, convertedAt: null };
      return l;
    });
    saveLeads(newLeads);
    const updated = newLeads.find(l => l.id === id);
    if (settings.supabaseUrl && updated) dbSaveLead(updated, settings).catch(() => {});
  };

  const handleUpdate = (id, updates) => {
    const newLeads = leads.map(l => l.id === id ? { ...l, ...updates } : l);
    saveLeads(newLeads);
    setSelectedLead(prev => prev?.id === id ? { ...prev, ...updates } : prev);
    const updated = newLeads.find(l => l.id === id);
    if (settings.supabaseUrl && updated) dbSaveLead(updated, settings).catch(() => {});
  };

  const handleAddLeads = newLeads => {
    const merged = [...leads];
    const truly_new = [];
    newLeads.forEach(nl => {
      if (!merged.find(l => l.id === nl.id)) { merged.push(nl); truly_new.push(nl); }
    });
    saveLeads(merged);
    // Bulk-upsert to Supabase
    if (settings.supabaseUrl && truly_new.length > 0) {
      dbSaveLeads(truly_new, settings).catch(() => {});
    }
  };

  const handlePreview = id => {
    const lead = leads.find(l => l.id === id);
    if (lead) setPreviewLead(lead);
  };

  // Called by SendPreviewModal after email is actually sent
  const handleSendPreviewSent = (id, emailAddr) => {
    addToast(`ğŸ“§ Preview sent to ${emailAddr}`);
    handleAction(id, "send_link");
    setSendPreviewLead(null);
  };

  const navItems = [
    { id: "dashboard", label: "Dashboard", icon: "ğŸ“Š" },
    { id: "find",      label: "Find Leads", icon: "ğŸ”" },
    { id: "pipeline",  label: "Pipeline",   icon: "ğŸ¯" },
    { id: "settings",  label: "Settings",   icon: "âš™ï¸" }
  ];

  const customerCount = leads.filter(l => l.stage === "customer").length;
  const overdueCount  = leads.filter(l => l.followUpAt && l.followUpAt < Date.now() && !["customer","archived"].includes(l.stage)).length;

  return (
    <div className="min-h-screen bg-slate-900 flex">
      {/* Sidebar */}
      <aside className={`${sidebarOpen ? "w-56" : "w-16"} bg-slate-950 border-r border-slate-800 flex flex-col transition-all duration-200 flex-shrink-0`}>
        <div className="p-4 border-b border-slate-800 flex items-center justify-between">
          {sidebarOpen && (
            <div>
              <div className="text-white font-bold text-sm">{APP_NAME}</div>
              <div className="text-slate-500 text-xs">Lead CRM</div>
            </div>
          )}
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-slate-400 hover:text-white text-lg ml-auto">
            {sidebarOpen ? "â—€" : "â–¶"}
          </button>
        </div>

        <nav className="flex-1 p-3 space-y-1">
          {navItems.map(item => (
            <button key={item.id} onClick={() => setView(item.id)}
              className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors
                ${view === item.id ? "bg-indigo-600 text-white" : "text-slate-400 hover:bg-slate-800 hover:text-white"}`}>
              <span className="text-base flex-shrink-0">{item.icon}</span>
              {sidebarOpen && <span>{item.label}</span>}
              {sidebarOpen && item.id === "pipeline" && overdueCount > 0 && (
                <span className="ml-auto bg-amber-500 text-black text-xs font-bold px-1.5 py-0.5 rounded-full">{overdueCount}</span>
              )}
            </button>
          ))}
        </nav>

        {sidebarOpen && customerCount > 0 && (
          <div className="p-3 border-t border-slate-800">
            <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3">
              <div className="text-xs text-emerald-400 font-medium">{customerCount} customer{customerCount !== 1 ? "s" : ""}</div>
              <div className="text-sm font-bold text-emerald-300">${customerCount * 5}/mo MRR</div>
            </div>
          </div>
        )}

        {/* Sign Out */}
        <div className="p-3 border-t border-slate-800/60">
          <button
            onClick={async () => {
              await auth.signOut(settings.supabaseUrl || "", settings.supabaseKey || "");
              setAuthed(false);
            }}
            className="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-xs text-slate-500 hover:text-red-400 hover:bg-red-500/10 transition-colors"
            title="Sign out"
          >
            <span>â†ª</span>
            {sidebarOpen && <span>Sign out</span>}
          </button>
        </div>
      </aside>

      {/* Main */}
      <main className="flex-1 overflow-auto p-6 min-w-0">
        {view === "dashboard" && <DashboardView leads={leads} settings={settings} addToast={addToast} onSync={() => syncFromSupabase(settings)} syncStatus={syncStatus} />}
        {view === "find"      && <FindLeadsView leads={leads} onAddLeads={handleAddLeads} />}
        {view === "pipeline"  && <PipelineView  leads={leads} onAction={handleAction} onSelect={setSelectedLead} onSendPreview={setSendPreviewLead} deploying={deploying} />}
        {view === "settings"  && <SettingsView  settings={settings} onSave={saveSettings} addToast={addToast} />}
      </main>

      {/* Lead Detail Modal */}
      {selectedLead && (
        <LeadModal
          lead={leads.find(l => l.id === selectedLead.id) || selectedLead}
          onClose={() => setSelectedLead(null)}
          onAction={handleAction}
          onUpdate={handleUpdate}
          onPreview={handlePreview}
          onSendPreview={setSendPreviewLead}
          deploying={deploying}
        />
      )}

      {/* Send Preview Modal */}
      {sendPreviewLead && (
        <SendPreviewModal
          lead={leads.find(l => l.id === sendPreviewLead.id) || sendPreviewLead}
          settings={settings}
          onClose={() => setSendPreviewLead(null)}
          onSent={handleSendPreviewSent}
        />
      )}

      {/* Website Preview Modal */}
      {previewLead && (
        <WebsitePreviewModal lead={previewLead} settings={settings} onClose={() => setPreviewLead(null)} />
      )}

      {/* Toasts */}
      <ToastContainer toasts={toasts} />
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
